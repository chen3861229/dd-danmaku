// @copyright    2022, RyoLee (https://github.com/RyoLee)
// @license      MIT; https://raw.githubusercontent.com/RyoLee/emby-danmaku/master/LICENSE
(async function(){"use strict";let requireDanmakuPath="https://danmaku.7o7o.cc/danmaku.min.js",corsProxy="https://ddplay-api.7o7o.cc/cors/";const openSourceLicense={self:{version:"1.44",name:"Emby Danmaku Extension(Forked form original:1.11)",license:"MIT License",url:"https://github.com/chen3861229/dd-danmaku"},original:{version:"1.11",name:"Emby Danmaku Extension",license:"MIT License",url:"https://github.com/RyoLee/emby-danmaku"},jellyfinFork:{version:"1.52",name:"Jellyfin Danmaku Extension",license:"MIT License",url:"https://github.com/Izumiko/jellyfin-danmaku"},danmaku:{version:"2.0.8",name:"Danmaku",license:"MIT License",url:"https://github.com/weizhenye/Danmaku"},dandanplayApi:{version:"v2",name:"弹弹 play API",license:"MIT License",url:"https://github.com/kaedei/dandanplay-libraryindex"},bangumiApi:{version:"2025-02-5",name:"Bangumi API",license:"None",url:"https://github.com/bangumi/api"},embyPluginDanmu:{version:"1.0.2",name:"EmbyPluginDanmu",license:"None",url:"https://github.com/fengymi/emby-plugin-danmu"}},dandanplayApi={prefix:corsProxy+"https://api.dandanplay.net/api/v2",getSearchEpisodes:(e,t)=>`${dandanplayApi.prefix}/search/episodes?anime=${e}${t?`&episode=${t}`:""}`,getComment:(e,t)=>`${dandanplayApi.prefix}/comment/${e}?withRelated=true&chConvert=${t}`,getExtcomment:e=>`${dandanplayApi.prefix}/extcomment?url=${encodeURI(e)}`,getBangumi:e=>`${dandanplayApi.prefix}/bangumi/${e}`,posterImg:e=>`https://img.dandanplay.net/anime/${e}.jpg`},bangumiApi={prefix:"https://api.bgm.tv/v0",accessTokenUrl:"https://next.bgm.tv/demo/access-token",getCharacters:e=>`${bangumiApi.prefix}/subjects/${e}/characters`,getMyself:()=>`${bangumiApi.prefix}/me`,postUserCollection:e=>`${bangumiApi.prefix}/users/-/collections/${e}`,getUserSubjectEpisodeCollection:e=>`${bangumiApi.prefix}/users/-/collections/${e}/episodes?offset=0&limit=100`,putUserEpisodeCollection:e=>`${bangumiApi.prefix}/users/-/collections/-/episodes/${e}`},check_interval=200,LOAD_TYPE={CHECK:"check",INIT:"init",REFRESH:"refresh",RELOAD:"reload",SEARCH:"search"};let isVersionOld=!1,mediaContainerQueryStr=".graphicContentContainer";const notHide=":not(.hide)",mediaQueryStr="video",iconKeys={replay_30:"replay_30",replay_10:"replay_10",replay_5:"replay_5",replay:"replay",reset:"repeat",forward_media:"forward_media",forward_5:"forward_5",forward_10:"forward_10",forward_30:"forward_30",comment:"comment",comments_disabled:"comments_disabled",switch_on:"toggle_on",switch_off:"toggle_off",setting:"tune",search:"search",done:"done_all",done_disabled:"remove_done",more:"more_horiz",close:"close",refresh:"refresh",block:"block",text_format:"translate",person:"person",sentiment_very_satisfied:"sentiment_very_satisfied",check:"check",edit:"edit"},currentDanmakuInfoContainerId="danmakuTab2",tabIframeId="danmakuTab5",danmakuTabOpts=[{id:"danmakuTab0",name:"弹幕设置",buildMethod:buildDanmakuSetting},{id:"danmakuTab1",name:"手动匹配",buildMethod:buildSearchEpisode},{id:currentDanmakuInfoContainerId,name:"弹幕信息",buildMethod:buildCurrentDanmakuInfo},{id:"danmakuTab3",name:"高级设置",buildMethod:buildProSetting},{id:"danmakuTab4",name:"关于",buildMethod:buildAbout},{id:tabIframeId,name:"内嵌网页",hidden:!0,buildMethod:buildIframe}],danmakuTypeFilterOpts={bottom:{id:"bottom",name:"底部弹幕"},top:{id:"top",name:"顶部弹幕"},ltr:{id:"ltr",name:"从左至右"},rtl:{id:"rtl",name:"从右至左"},rolling:{id:"rolling",name:"滚动弹幕"},onlyWhite:{id:"onlyWhite",name:"彩色弹幕"},emoji:{id:"emoji",name:"emoji"}},danmakuSource={AcFun:{id:"AcFun",name:"A站(AcFun)"},BiliBili:{id:"BiliBili",name:"B站(BiliBili)"},DanDanPlay:{id:"DanDanPlay",name:"弹弹(DanDanPlay)"},D:{id:"D",name:"D"},Gamer:{id:"Gamer",name:"巴哈(Gamer)"},iqiyi:{id:"iqiyi",name:"爱奇艺(iqiyi)"},QQ:{id:"QQ",name:"腾讯视频(QQ)"},Youku:{id:"Youku",name:"优酷(Youku)"},"5dm":{id:"5dm",name:"D站(5dm)"},"异世界动漫":{id:"异世界动漫",name:"异世界动漫"}},showSource={source:{id:"source",name:"来源平台"},originalUserId:{id:"originalUserId",name:"用户ID"},cid:{id:"cid",name:"弹幕CID"}},danmakuEngineOpts=[{id:"canvas",name:"canvas"},{id:"dom",name:"dom"}],danmakuChConverOpts=[{id:"0",name:"未启用"},{id:"1",name:"转换为简体"},{id:"2",name:"转换为繁体"}],embyOffsetBtnStyle="margin: 0;padding: 0;",timeOffsetBtns=[{label:"-30",valueOffset:"-30",iconKey:iconKeys.replay_30,style:embyOffsetBtnStyle},{label:"-10",valueOffset:"-10",iconKey:iconKeys.replay_10,style:embyOffsetBtnStyle},{label:"-5",valueOffset:"-5",iconKey:iconKeys.replay_5,style:embyOffsetBtnStyle},{label:"-1",valueOffset:"-1",iconKey:iconKeys.replay,style:embyOffsetBtnStyle},{label:"0",valueOffset:"0",iconKey:iconKeys.reset,style:embyOffsetBtnStyle},{label:"+1",valueOffset:"1",iconKey:iconKeys.replay,style:embyOffsetBtnStyle+" transform: rotateY(180deg);"},{label:"+5",valueOffset:"5",iconKey:iconKeys.forward_5,style:embyOffsetBtnStyle},{label:"+10",valueOffset:"10",iconKey:iconKeys.forward_10,style:embyOffsetBtnStyle},{label:"+30",valueOffset:"30",iconKey:iconKeys.forward_30,style:embyOffsetBtnStyle}],toastPrefixes={system:"[系统通知] : "},hasToastPrefixes=(e,t)=>Object.values(t).some((t=>e.text.startsWith(t))),getDanmakuComments=e=>e.danmaku&&e.danmaku.comments?e.danmaku.comments.filter((e=>!hasToastPrefixes(e,toastPrefixes))):[],danmuListOpts=[{id:"0",name:"不展示",onChange:()=>[]},{id:"1",name:"屏中",onChange:e=>e.danmaku?e.danmaku._.runningList:[]},{id:"2",name:"所有",onChange:e=>e.commentsParsed},{id:"3",name:"已加载",onChange:getDanmakuComments},{id:"4",name:"被过滤",onChange:e=>e.commentsParsed.filter((t=>!getDanmakuComments(e).some((e=>t.cuid===e.cuid))))},{id:"5",name:"已相似合并",onChange:e=>e.commentsParsed.filter((e=>e.xCount))},{id:"100",name:"通知",onChange:e=>e.danmaku?e.danmaku.comments.filter((e=>hasToastPrefixes(e,toastPrefixes))):[]}],timeoutCallbackUnitOpts=[{id:"0",name:"秒",msRate:1e3},{id:"1",name:"分",msRate:6e4},{id:"2",name:"时",msRate:36e5}];let timeoutCallbackId;const timeoutCallbackClear=()=>timeoutCallbackId&&clearTimeout(timeoutCallbackId),timeoutCallbackTypeOpts=[{id:"0",name:"不启用",onChange:()=>timeoutCallbackClear()},{id:"1",name:"退出播放",onChange:e=>{timeoutCallbackClear(),timeoutCallbackId=setTimeout((()=>{closeEmbyDialog(),Emby.InputManager.trigger("back")}),e)}},{id:"2",name:"返回主页",onChange:e=>{timeoutCallbackClear(),timeoutCallbackId=setTimeout((()=>{closeEmbyDialog(),Emby.Page.goHome()}),e)}}],getApiTl=e=>e.toString().match(/\=>\s*(.*)$/)[1].trim().replace(/`/g,""),labels={enable:"启用"},lsKeys={chConvert:{id:"danmakuChConvert",defaultValue:1,name:"简繁转换"},switch:{id:"danmakuSwitch",defaultValue:!0,name:"弹幕开关"},filterLevel:{id:"danmakuFilterLevel",defaultValue:0,name:"过滤强度",min:0,max:3,step:1},heightPercent:{id:"danmakuHeightPercent",defaultValue:100,name:"显示区域",min:3,max:100,step:1},fontSizeRate:{id:"danmakuFontSizeRate",defaultValue:1,name:"弹幕大小",min:.1,max:3,step:.1},fontOpacity:{id:"danmakuFontOpacity",defaultValue:1,name:"透明度",min:.1,max:1,step:.1},speed:{id:"danmakuBaseSpeed",defaultValue:1,name:"速度",min:.1,max:3,step:.1},timelineOffset:{id:"danmakuTimelineOffset",defaultValue:0,name:"轴偏秒"},fontWeight:{id:"danmakuFontWeight",defaultValue:400,name:"弹幕粗细",min:100,max:1e3,step:100},fontStyle:{id:"danmakuFontStyle",defaultValue:0,name:"弹幕斜体",min:0,max:2,step:1},fontFamily:{id:"danmakuFontFamily",defaultValue:"sans-serif",name:"字体"},danmuList:{id:"danmakuDanmuList",defaultValue:0,name:"弹幕列表"},typeFilter:{id:"danmakuTypeFilter",defaultValue:[],name:"屏蔽类型"},sourceFilter:{id:"danmakuSourceFilter",defaultValue:[],name:"屏蔽来源平台"},showSource:{id:"danmakuShowSource",defaultValue:[],name:"显示每条来源"},autoFilterCount:{id:"danmakuAutoFilterCount",defaultValue:0,name:"自动过滤弹幕数阈值",min:0,max:1e4,step:500},mergeSimilarEnable:{id:"danmakuMergeSimilarEnable",defaultValue:!1,name:"合并相似弹幕"},mergeSimilarPercent:{id:"danmakuMergeSimilarPercent",defaultValue:80,name:"相似度百分比",min:20,max:100,step:1},mergeSimilarTime:{id:"danmakuMergeSimilarTime",defaultValue:10,name:"相似度时间窗口秒",min:1,max:60,step:1},filterKeywords:{id:"danmakuFilterKeywords",defaultValue:"",name:"屏蔽关键词"},filterKeywordsEnable:{id:"danmakuFilterKeywordsEnable",defaultValue:!0,name:"屏蔽关键词启用"},osdTitleEnable:{id:"danmakuOsdTitleEnable",defaultValue:!1,name:"播放界面右下角显示弹幕信息"},osdLineChartEnable:{id:"danmakuOsdLineChartEnable",defaultValue:!1,name:"进度条上显示弹幕每秒内数量折线图"},osdHeaderClockEnable:{id:"danmakuOsdHeaderClockEnable",defaultValue:!1,name:"播放界面头中显示时钟"},engine:{id:"danmakuEngine",defaultValue:"canvas",name:"弹幕引擎"},timeoutCallbackUnit:{id:"danmakuTimeoutCallbackUnit",defaultValue:1,name:"定时单位"},timeoutCallbackValue:{id:"danmakuTimeoutCallbackValue",defaultValue:0,name:"定时值"},bangumiEnable:{id:"danmakuBangumiEnable",defaultValue:!1,name:"启用并填写个人令牌"},bangumiToken:{id:"danmakuBangumiToken",defaultValue:"",name:"个人令牌"},bangumiPostPercent:{id:"danmakuBangumiPostPercent",defaultValue:95,name:"时长比",min:1,max:99,step:1},consoleLogEnable:{id:"danmakuConsoleLogEnable",defaultValue:!1,name:"控制台日志"},useFetchPluginXml:{id:"danmakuUseFetchPluginXml",defaultValue:!1,name:"加载媒体服务端xml弹幕"},debugShowDanmakuWrapper:{id:"danmakuDebugShowDanmakuWrapper",defaultValue:!1,name:"弹幕容器边界"},debugShowDanmakuCtrWrapper:{id:"danmakuDebugShowDanmakuCtrWrapper",defaultValue:!1,name:"按钮容器边界"},debugReverseDanmu:{id:"danmakuDebugReverseDanmu",defaultValue:!1,name:"反转弹幕方向"},debugRandomDanmuColor:{id:"danmakuDebugRandomDanmuColor",defaultValue:!1,name:"随机弹幕颜色"},debugForceDanmuWhite:{id:"danmakuDebugForceDanmuWhite",defaultValue:!1,name:"强制弹幕白色"},debugGenerateLarge:{id:"danmakuDebugGenerateLarge",defaultValue:!1,name:"测试大量弹幕"},debugDialogHyalinize:{id:"danmakuDebugDialogHyalinize",defaultValue:!1,name:"透明弹窗背景"},debugDialogWindow:{id:"danmakuDebugDialogWindow",defaultValue:!1,name:"弹窗窗口化"},debugDialogRight:{id:"danmakuDebugDialogRight",defaultValue:!1,name:"弹窗靠右布局"},debugTabIframeEnable:{id:"danmakuDebugTabIframeEnable",defaultValue:!1,name:"打开内嵌网页"},quickDebugOn:{id:"danmakuQuickDebugOn",defaultValue:!1,name:"快速调试"},customeCorsProxyUrl:{id:"danmakuCustomeCorsProxyUrl",defaultValue:corsProxy,name:"跨域代理前缀"},customeDanmakuUrl:{id:"danmakuCustomeDanmakuUrl",defaultValue:requireDanmakuPath,name:"弹幕引擎依赖"},customeGetCommentUrl:{id:"danmakuCustomeGetCommentUrl",defaultValue:getApiTl(dandanplayApi.getComment),name:"获取指定弹幕库的所有弹幕"},customeGetExtcommentUrl:{id:"danmakuCustomeGetExtcommentUrl",defaultValue:getApiTl(dandanplayApi.getExtcomment),name:"获取指定第三方url的弹幕"},customePosterImgUrl:{id:"danmakuCustomePosterImgUrl",defaultValue:getApiTl(dandanplayApi.posterImg),name:"媒体海报"}},eleIds={danmakuSwitchBtn:"danmakuSwitchBtn",danmakuCtr:"danmakuCtr",danmakuWrapper:"danmakuWrapper",h5VideoAdapter:"h5VideoAdapter",dialogContainer:"dialogContainer",danmakuSwitchDiv:"danmakuSwitchDiv",danmakuSwitch:"danmakuSwitch",filterLevelDiv:"filterLevelDiv",danmakuSearchNameDiv:"danmakuSearchNameDiv",danmakuSearchName:"danmakuSearchName",danmakuEpisodeFlag:"danmakuEpisodeFlag",danmakuAnimeDiv:"danmakuAnimeDiv",danmakuSwitchEpisode:"danmakuSwitchEpisode",danmakuEpisodeNumDiv:"danmakuEpisodeNumDiv",danmakuEpisodeLoad:"danmakuEpisodeLoad",danmakuRemark:"danmakuRemark",danmakuAnimeSelect:"danmakuAnimeSelect",danmakuEpisodeNumSelect:"danmakuEpisodeNumSelect",searchImgDiv:"searchImgDiv",searchImg:"searchImg",extCommentSearchDiv:"extCommentSearchDiv",extUrlsDiv:"extUrlsDiv",currentMatchedDiv:"currentMatchedDiv",filteringDanmaku:"filteringDanmaku",danmakuTypeFilterDiv:"danmakuTypeFilterDiv",danmakuTypeFilterSelectName:"danmakuTypeFilterSelectName",danmakuSourceFilterDiv:"danmakuSourceFilterDiv",danmakuSourceFilterSelectName:"danmakuSourceFilterSelectName",danmakuShowSourceDiv:"danmakuShowSourceDiv",danmakuShowSourceSelectName:"danmakuShowSourceSelectName",danmakuAutoFilterCountDiv:"danmakuAutoFilterCountDiv",danmakuFilterProDiv:"danmakuFilterProDiv",mergeSimilarPercentDiv:"mergeSimilarPercentDiv",mergeSimilarTimeDiv:"mergeSimilarTimeDiv",posterImgDiv:"posterImgDiv",danmuListDiv:"danmuListDiv",danmuListText:"danmakuListText",extInfoCtrlDiv:"extInfoCtrlDiv",extInfoDiv:"extInfoDiv",characterImgHeihtDiv:"characterImgHeihtDiv",characterImgHeihtLabel:"characterImgHeihtLabel",charactersDiv:"charactersDiv",filterKeywordsDiv:"filterKeywordsDiv",danmakuChConverDiv:"danmakuChConverDiv",danmakuEngineDiv:"danmakuEngineDiv",heightPercentDiv:"heightPercentDiv",danmakuSizeDiv:"danmakuSizeDiv",danmakuOpacityDiv:"danmakuOpacityDiv",danmakuSpeedDiv:"danmakuSpeedDiv",danmakuFontWeightDiv:"danmakuFontWeightDiv",danmakuFontStyleDiv:"danmakuFontStyleDiv",timelineOffsetDiv:"timelineOffsetDiv",fontFamilyCtrl:"fontFamilyCtrl",fontFamilyDiv:"fontFamilyDiv",fontFamilyLabel:"fontFamilyLabel",fontFamilySelect:"fontFamilySelect",fontFamilyInput:"fontFamilyInput",fontStylePreview:"fontStylePreview",settingsCtrl:"settingsCtrl",settingsText:"settingsText",settingsImportBtn:"settingsImportBtn",settingReloadBtn:"settingReloadBtn",filterKeywordsEnableId:"filterKeywordsEnableId",filterKeywordsId:"filterKeywordsId",timeoutCallbackDiv:"timeoutCallbackDiv",timeoutCallbackLabel:"timeoutCallbackLabel",timeoutCallbackTypeDiv:"timeoutCallbackTypeDiv",timeoutCallbackUnitDiv:"timeoutCallbackUnitDiv",bangumiEnableLabel:"bangumiEnableLabel",bangumiSettingsDiv:"bangumiSettingsDiv",bangumiTokenInput:"bangumiTokenInput",bangumiTokenInputDiv:"bangumiTokenInputDiv",bangumiTokenLabel:"bangumiTokenInputLabel",bangumiTokenLinkDiv:"bangumiTokenLinkDiv",bangumiPostPercentDiv:"bangumiPostPercentDiv",customeUrlsDiv:"customeUrlsDiv",customeCorsProxyDiv:"customeCorsProxyDiv",customeDanmakuDiv:"customeDanmakuDiv",customeGetCommentDiv:"customeGetCommentDiv",customeGetExtcommentDiv:"customeGetExtcommentDiv",customePosterImgDiv:"customePosterImgDiv",consoleLogCtrl:"consoleLogCtrl",consoleLogInfo:"consoleLogInfo",consoleLogText:"consoleLogText",consoleLogTextInput:"consoleLogTextInput",consoleLogCountLabel:"consoleLogCountLabel",debugCheckbox:"debugCheckbox",debugButton:"debugButton",tabIframe:"tabIframe",tabIframeHeightDiv:"tabIframeHeightDiv",tabIframeHeightLabel:"tabIframeHeightLabel",tabIframeCtrlDiv:"tabIframeCtrlDiv",tabIframeSrcInputDiv:"tabIframeSrcInputDiv",openSourceLicenseDiv:"openSourceLicenseDiv",videoOsdDanmakuTitle:"videoOsdDanmakuTitle",extCheckboxDiv:"extCheckboxDiv",danmuPluginDiv:"danmuPluginDiv",danmakuSettingBtnDebug:"danmakuSettingBtnDebug",progressBarLineChart:"progressBarLineChart"},mediaBtnOpts=[{id:eleIds.danmakuSwitchBtn,label:"弹幕开关",iconKey:iconKeys.comment,onClick:doDanmakuSwitch},{label:"弹幕设置",iconKey:iconKeys.setting,onClick:createDialog}],customeUrlMsg1="限弹弹 play API 兼容结构",customeUrl={init:()=>customeUrl.mapping.map((e=>e.rewrite(lsGetItem(e.lsKey.id)))),mapping:[{divId:eleIds.customeDanmakuDiv,lsKey:lsKeys.customeDanmakuUrl,rewrite:e=>{requireDanmakuPath=e},msg1:`限 ${openSourceLicense.danmaku.url} 兼容结构`,msg2:"Danmaku 依赖路径,index.html 引入的和篡改猴环境不会使用到,依赖已内置,\n                        仅在被 CustomCssJS 执行的特殊环境下使用,支持相对/绝对/网络路径,\n                        默认是相对路径等同 https://emby/web/ 和 /system/dashboard-ui/ ,非浏览器客户端必须使用网络路径"},{divId:eleIds.customeCorsProxyDiv,lsKey:lsKeys.customeCorsProxyUrl,rewrite:e=>{corsProxy=e},msg1:"仅弹弹 play API 跨域使用,限 URL 前缀反代方式,例如 cf_worker",msg2:"以下共用变量: { dandanplayApi.prefix: 反代前缀拼接的弹弹 play API 路径前缀, }"},{divId:eleIds.customeGetCommentDiv,lsKey:lsKeys.customeGetCommentUrl,rewrite:tl=>{dandanplayApi.getComment=(episodeId,chConvert)=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { episodeId: 章节 ID, chConvert: 简繁转换, }"},{divId:eleIds.customeGetExtcommentDiv,lsKey:lsKeys.customeGetExtcommentUrl,rewrite:tl=>{dandanplayApi.getExtcomment=url=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { url: 附加弹幕输入框中的网址, }"},{divId:eleIds.customePosterImgDiv,lsKey:lsKeys.customePosterImgUrl,rewrite:tl=>{dandanplayApi.posterImg=animeId=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { animeId: 弹弹 play 的作品 ID, }"}]},classes={dialogContainer:"dialogContainer",dialogBackdropOpened:"dialogBackdropOpened",dialogBlur:"dialog-blur",dialog:"dialog",formDialogHeader:"formDialogHeader",formDialogFooter:"formDialogFooter",formDialogFooterItem:"formDialogFooterItem",dialogFullscreen:"dialog-fullscreen",dialogFullscreenLowres:"dialog-fullscreen-lowres",videoOsdTitle:"videoOsdTitle",videoOsdBottomButtons:"videoOsdBottom-buttons",videoOsdBottomButtonsTopRight:"videoOsdBottom-buttons-topright",videoOsdBottomButtonsRight:"videoOsdBottom-buttons-right",videoOsdPositionSliderContainer:"videoOsdPositionSliderContainer",cardImageIcon:"cardImageIcon",headerRight:"headerRight",headerUserButton:"headerUserButton",mdlSpinner:"mdl-spinner",collapseContentNav:"collapseContent navDrawerCollapseContent",embyLabel:"inputLabel",embyInput:"emby-input emby-input-smaller",embySelectWrapper:"emby-select-wrapper",embySelectTv:"emby-select-tv",embyCheckboxList:"checkboxList",embyFieldDesc:"fieldDescription",embyTabsMenu:"headerMiddle headerSection sectionTabs headerMiddle-withSectionTabs",embyTabsDiv1:"tabs-viewmenubar tabs-viewmenubar-backgroundcontainer focusable scrollX hiddenScrollX smoothScrollX scrollFrameX emby-tabs",embyTabsDiv2:"tabs-viewmenubar-slider emby-tabs-slider padded-left padded-right nohoverfocus scrollSliderX",embyTabsButton:"emby-button secondaryText emby-tab-button main-tab-button",embyButtons:{basic:"raised emby-button",submit:"button-submit",help:"button-help",link:"button-link",iconButton:"flex-shrink-zero paper-icon-button-light"}},styles={embyCheckboxList:"display: flex;flex-wrap: wrap;",embySliderList:"display: flex;flex-direction: column;justify-content: center;align-items: center;",embySlider:"display: flex; align-items: center; margin-bottom: 0.3em;",embySliderLabel:"width: 4em; margin-left: 1em;",rightLayout:"position: fixed; right: 0; width: 40%; min-width: auto; min-height: auto; max-width: 100%; max-height: 100%;",colors:{info:16777215,success:65280,warn:16776960,error:16711680,highlight:"rgba(115, 160, 255, 0.3)",switchActiveColor:"#52b54b"},fontStyles:[{id:"normal",name:"正常"},{id:"italic",name:"原生斜体"},{id:"oblique",name:"形变斜体"}]};function objectEntries(e){return e&&"object"==typeof e?Object.keys(e).map((t=>[t,e[t]])):[]}const OS={isAndroid:()=>/android/i.test(navigator.userAgent),isIOS:()=>/iPad|iPhone|iPod/i.test(navigator.userAgent),isMacOS:()=>/Macintosh|MacIntel/i.test(navigator.userAgent),isApple:()=>OS.isMacOS()||OS.isIOS(),isWindows:()=>/compatible|Windows/i.test(navigator.userAgent),isMobile:()=>OS.isAndroid()||OS.isIOS(),isUbuntu:()=>/Ubuntu/i.test(navigator.userAgent),isAndroidEmbyNoisyX:()=>OS.isAndroid()&&ApiClient.appVersion().includes("-"),isEmbyNoisyX:()=>ApiClient.appVersion().includes("-"),isOthers:()=>objectEntries(OS).filter((([e,t])=>"isOthers"!==e)).every((([e,t])=>!t()))},emojiRegex=/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F900}-\u{1F9FF}\u{1F1E6}-\u{1F1FF}]/gu;let skipInnerModule=!1;try{throw new Error}catch(e){skipInnerModule=e.stack&&e.stack.includes("CustomCssJS")}var t,e;skipInnerModule?window.Danmaku||Emby.importModule(requireDanmakuPath).then((e=>{console.log(e),window.Danmaku=e})).catch((e=>{console.error("fail Emby.importModule error:",e)})):(t=this,e=function(){var e=function(){if("undefined"==typeof document)return"transform";for(var e=["oTransform","msTransform","mozTransform","webkitTransform","transform"],t=document.createElement("div").style,n=0;n<e.length;n++)if(e[n]in t)return e[n];return"transform"}();function t(e){var t=document.createElement("div");if(t.style.cssText="position:absolute;","function"==typeof e.render){var n=e.render();if(n instanceof HTMLElement)return t.appendChild(n),t}if(t.textContent=e.text,e.style)for(var i in e.style)t.style[i]=e.style[i];return t}var n={name:"dom",init:function(){var e=document.createElement("div");return e.style.cssText="overflow:hidden;white-space:nowrap;transform:translateZ(0);",e},clear:function(e){for(var t=e.lastChild;t;)e.removeChild(t),t=e.lastChild},resize:function(e,t,n){e.style.width=t+"px",e.style.height=n+"px"},framing:function(){},setup:function(e,n){var i=document.createDocumentFragment(),a=0,l=null;for(a=0;a<n.length;a++)(l=n[a]).node=l.node||t(l),i.appendChild(l.node);for(n.length&&e.appendChild(i),a=0;a<n.length;a++)(l=n[a]).width=l.width||l.node.offsetWidth,l.height=l.height||l.node.offsetHeight},render:function(t,n){n.node.style[e]="translate("+n.x+"px,"+n.y+"px)"},remove:function(e,t){e.removeChild(t.node),this.media||(t.node=null)}},i="undefined"!=typeof window&&window.devicePixelRatio||1,a=Object.create(null);function l(e,t){if("function"==typeof e.render){var n=e.render();if(n instanceof HTMLCanvasElement)return e.width=n.width,e.height=n.height,n}var l=document.createElement("canvas"),s=l.getContext("2d"),o=e.style||{};o.font=o.font||"10px sans-serif",o.textBaseline=o.textBaseline||"bottom";var d=1*o.lineWidth;for(var r in d=d>0&&d!==1/0?Math.ceil(d):1*!!o.strokeStyle,s.font=o.font,e.width=e.width||Math.max(1,Math.ceil(s.measureText(e.text).width)+2*d),e.height=e.height||Math.ceil(function(e,t){if(a[e])return a[e];var n=12,i=e.match(/(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/);if(i){var l=1*i[1]||10,s=i[2],o=1*i[3]||1.2,d=i[4];"%"===s&&(l*=t.container/100),"em"===s&&(l*=t.container),"rem"===s&&(l*=t.root),"px"===d&&(n=o),"%"===d&&(n=l*o/100),"em"===d&&(n=l*o),"rem"===d&&(n=t.root*o),void 0===d&&(n=l*o)}return a[e]=n,n}(o.font,t))+2*d,l.width=e.width*i,l.height=e.height*i,s.scale(i,i),o)s[r]=o[r];var m=0;switch(o.textBaseline){case"top":case"hanging":m=d;break;case"middle":m=e.height>>1;break;default:m=e.height-d}return o.strokeStyle&&s.strokeText(e.text,d,m),s.fillText(e.text,d,m),l}function s(e){return 1*window.getComputedStyle(e,null).getPropertyValue("font-size").match(/(.+)px/)[1]}var o={name:"canvas",init:function(e){var t=document.createElement("canvas");return t.context=t.getContext("2d"),t._fontSize={root:s(document.getElementsByTagName("html")[0]),container:s(e)},t},clear:function(e,t){e.context.clearRect(0,0,e.width,e.height);for(var n=0;n<t.length;n++)t[n].canvas=null},resize:function(e,t,n){e.width=t*i,e.height=n*i,e.style.width=t+"px",e.style.height=n+"px"},framing:function(e){e.context.clearRect(0,0,e.width,e.height)},setup:function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.canvas=l(i,e._fontSize)}},render:function(e,t){e.context.drawImage(t.canvas,t.x*i,t.y*i)},remove:function(e,t){t.canvas=null}},d=("undefined"!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(e){return setTimeout(e,50/3)}).bind(window),r=("undefined"!=typeof window&&(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame)||clearTimeout).bind(window);function m(e,t,n){for(var i=0,a=0,l=e.length;a<l-1;)n>=e[i=a+l>>1][t]?a=i:l=i;return e[a]&&n<e[a][t]?a:l}function c(e){return/^(ltr|top|bottom)$/i.test(e)?e.toLowerCase():"rtl"}function u(){var e=9007199254740991;return[{range:0,time:-e,width:e,height:0},{range:e,time:e,width:0,height:0}]}function y(e){e.ltr=u(),e.rtl=u(),e.top=u(),e.bottom=u()}function g(){return void 0!==window.performance&&window.performance.now?window.performance.now():Date.now()}function b(e){var t=this,n=this.media?this.media.currentTime:g()/1e3,i=this.media?this.media.playbackRate:1;function a(e,a){if("top"===a.mode||"bottom"===a.mode)return n-e.time<t._.duration;var l=(t._.width+e.width)*(n-e.time)*i/t._.duration;if(e.width>l)return!0;var s=t._.duration+e.time-n,o=t._.width+a.width,d=t.media?a.time:a._utc,r=o*(n-d)*i/t._.duration,m=t._.width-r;return s>t._.duration*m/(t._.width+a.width)}for(var l=this._.space[e.mode],s=0,o=0,d=1;d<l.length;d++){var r=l[d],m=e.height;if("top"!==e.mode&&"bottom"!==e.mode||(m+=r.height),r.range-r.height-l[s].range>=m){o=d;break}a(r,e)&&(s=d)}var c=l[s].range,u={range:c+e.height,time:this.media?e.time:e._utc,width:e.width,height:e.height};return l.splice(s+1,o-s-1,u),"bottom"===e.mode?this._.height-e.height-c%this._.height:c%(this._.height-e.height)}function p(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var e=0;e<this._.runningList.length;e++){var t=this._.runningList[e];t._utc=g()/1e3-(this.media.currentTime-t.time)}var n=this,i=function(e,t,n,i){return function(a){e(this._.stage);var l=(a||g())/1e3,s=this.media?this.media.currentTime:l,o=this.media?this.media.playbackRate:1,d=null,r=0,m=0;for(m=this._.runningList.length-1;m>=0;m--)d=this._.runningList[m],s-(r=this.media?d.time:d._utc)>this._.duration&&(i(this._.stage,d),this._.runningList.splice(m,1));for(var c=[];this._.position<this.comments.length&&(d=this.comments[this._.position],!((r=this.media?d.time:d._utc)>=s));)s-r>this._.duration||(this.media&&(d._utc=l-(this.media.currentTime-d.time)),c.push(d)),++this._.position;for(t(this._.stage,c),m=0;m<c.length;m++)(d=c[m]).y=b.call(this,d),this._.runningList.push(d);for(m=0;m<this._.runningList.length;m++){d=this._.runningList[m];var u=(this._.width+d.width)*(l-d._utc)*o/this._.duration;"ltr"===d.mode&&(d.x=u-d.width),"rtl"===d.mode&&(d.x=this._.width-u),"top"!==d.mode&&"bottom"!==d.mode||(d.x=this._.width-d.width>>1),n(this._.stage,d)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=d((function e(t){i.call(n,t),n._.requestID=d(e)})),this}function h(){return!this._.visible||this._.paused||(this._.paused=!0,r(this._.requestID),this._.requestID=0),this}function f(){if(!this.media)return this;this.clear(),y(this._.space);var e=m(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,e-1),this}function v(e){e.play=p.bind(this),e.pause=h.bind(this),e.seeking=f.bind(this),this.media.addEventListener("play",e.play),this.media.addEventListener("pause",e.pause),this.media.addEventListener("playing",e.play),this.media.addEventListener("waiting",e.pause),this.media.addEventListener("seeking",e.seeking)}function I(e){this.media.removeEventListener("play",e.play),this.media.removeEventListener("pause",e.pause),this.media.removeEventListener("playing",e.play),this.media.removeEventListener("waiting",e.pause),this.media.removeEventListener("seeking",e.seeking),e.play=null,e.pause=null,e.seeking=null}function k(e){this._={},this.container=e.container||document.createElement("div"),this.media=e.media,this._.visible=!0,this.engine=(e.engine||"DOM").toLowerCase(),this._.engine="canvas"===this.engine?o:n,this._.requestID=0,this._.speed=Math.max(0,e.speed)||144,this._.duration=4,this.comments=e.comments||[],this.comments.sort((function(e,t){return e.time-t.time}));for(var t=0;t<this.comments.length;t++)this.comments[t].mode=c(this.comments[t].mode);return this._.runningList=[],this._.position=0,this._.paused=!0,this.media&&(this._.listener={},v.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style.cssText+="position:relative;pointer-events:none;",this.resize(),this.container.appendChild(this._.stage),this._.space={},y(this._.space),this.media&&this.media.paused||(f.call(this),p.call(this)),this}function w(){if(!this.container)return this;for(var e in h.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&I.call(this,this._.listener),this)Object.prototype.hasOwnProperty.call(this,e)&&(this[e]=null);return this}var S=["mode","time","text","render","style"];function C(e){if(!e||"[object Object]"!==Object.prototype.toString.call(e))return this;for(var t={},n=0;n<S.length;n++)void 0!==e[S[n]]&&(t[S[n]]=e[S[n]]);if(t.text=(t.text||"").toString(),t.mode=c(t.mode),t._utc=g()/1e3,this.media){var i=0;void 0===t.time?(t.time=this.media.currentTime,i=this._.position):(i=m(this.comments,"time",t.time))<this._.position&&(this._.position+=1),this.comments.splice(i,0,t)}else this.comments.push(t);return this}function D(){return this._.visible||(this._.visible=!0,this.media&&this.media.paused||(f.call(this),p.call(this))),this}function x(){return this._.visible?(h.call(this),this.clear(),this._.visible=!1,this):this}function E(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function L(){return this._.width=this.container.offsetWidth,this._.height=this.container.offsetHeight,this._.engine.resize(this._.stage,this._.width,this._.height),this._.duration=this._.width/this._.speed,this}var T={get:function(){return this._.speed},set:function(e){return"number"!=typeof e||isNaN(e)||!isFinite(e)||e<=0?this._.speed:(this._.speed=e,this._.width&&(this._.duration=this._.width/e),e)}};function $(e){e&&k.call(this,e)}return $.prototype.destroy=function(){return w.call(this)},$.prototype.emit=function(e){return C.call(this,e)},$.prototype.show=function(){return D.call(this)},$.prototype.hide=function(){return x.call(this)},$.prototype.clear=function(){return E.call(this)},$.prototype.resize=function(){return L.call(this)},Object.defineProperty($.prototype,"speed",T),$},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Danmaku=e());class EDE{constructor(){this.chConvert=lsGetItem(lsKeys.chConvert.id),this.danmaku=null,this.episode_info=null,this.ob=null,this.loading=!1,this.danmuCache={},this.commentsParsed=[],this.extCommentCache={},this.destroyIntervalIds=[],this.searchDanmakuOpts={},this.appLogAspect=null,this.bangumiInfo={},this.itemId="",this.tempLsValues={}}}class AppLogAspect{constructor(){this.initialized=!1,this.originalError=console.error,this.originalWarn=console.warn,this.originalLog=console.log,this.originalOnerror=null,this.value="",this.listeners=[],this.ERROR={text:"ERROR",emoji:"❗️"},this.WARN={text:"WARN",emoji:"⚠️"},this.INFO={text:"INFO",emoji:"❕"}}init(){return this.initialized||(console.error=(...e)=>{this.originalError.apply(console,e),this.value+=this.format(this.ERROR,e),this.notifyListeners()},console.warn=(...e)=>{this.originalWarn.apply(console,e),this.value+=this.format(this.WARN,e),this.notifyListeners()},console.log=(...e)=>{this.originalLog.apply(console,e),this.value+=this.format(this.INFO,e),this.notifyListeners()},this.originalOnerror=window.onerror,window.onerror=(...e)=>{console.error(e),"function"==typeof this.originalOnerror&&this.originalOnerror(...e)},this.initialized=!0),this}destroy(e=!0){return this.initialized&&(console.error=this.originalError,console.warn=this.originalWarn,console.log=this.originalLog,window.onerror=this.originalOnerror,e&&(this.value=""),this.listeners=[],this.initialized=!1),this}format(e,t){const n=e.emoji?`[${e.emoji}] `:"";return`[${new Date(Date.now()).toLocaleString()}] [${e.text}] ${n}: `+t.map((e=>e instanceof Error?e.message:"string"==typeof e?e:JSON.stringify(e))).join(" ")+"\n"}on(e){if(e.toString().includes("console.log")||e.toString().includes("console.error"))throw new Error("The callback function must not contain console.log or console.error to avoid infinite loops.");this.listeners.push((()=>e(this.value)))}notifyListeners(){this.listeners.forEach((e=>e()))}clearValue(){this.value="",this.notifyListeners()}}function initListener(){const e=document.querySelector(mediaQueryStr);e?e.getAttribute("ede_listening")||(console.log("正在初始化Listener"),playbackEventsOn({playbackstart:(e,t)=>{console.log(e.type),loadDanmaku(LOAD_TYPE.INIT)}}),playbackEventsOn({playbackstop:(e,t)=>{console.log(e.type),onPlaybackStop(e,t),removeHeaderClock(),danmakuAutoFilterCancel()}}),e.setAttribute("ede_listening",!0),document.addEventListener("video-osd-show",(e=>{console.log(e.type,e),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20),addHeaderClock()})),document.addEventListener("video-osd-hide",(e=>{console.log(e.type,e),removeHeaderClock()})),console.log("Listener初始化完成"),OS.isAndroidEmbyNoisyX()&&(console.log("检测为安卓小秘版,首次播放未触发 playbackstart 事件,手动初始化弹幕环境"),loadDanmaku(LOAD_TYPE.INIT))):window.ede.episode_info&&(window.ede.episode_info=null)}function initUI(){if(getById(eleIds.danmakuCtr))return;console.log("正在初始化UI"),parseFloat(ApiClient.serverVersion())<4.8&&(mediaContainerQueryStr='div[data-type="video-osd"]',isVersionOld=!0),mediaContainerQueryStr.includes(notHide)||(mediaContainerQueryStr+=notHide);waitForElement(`${mediaContainerQueryStr} .videoOsdBottom-maincontrols`,(e=>{const t=getByClass(classes.videoOsdBottomButtons+=notHide,e);e=t||getByClass(classes.videoOsdBottomButtonsTopRight,e);const n=getByClass(classes.videoOsdBottomButtonsRight,e),i=document.createElement("div");i.id=eleIds.danmakuCtr,window.ede.episode_info||(i.style.opacity=.5),n?e.insertBefore(i,n):e.append(i),mediaBtnOpts.forEach((e=>{i.appendChild(embyButton(e,e.onClick))})),console.log("UI初始化完成")}),0)}async function getEmbyItemInfo(){return require(["playbackManager"]).then((e=>e[0].currentItem()))}async function fatchEmbyItemInfo(e){if(e)return await ApiClient.getItem(ApiClient.getCurrentUserId(),e)}async function fetchSearchEpisodes(e,t){if(!e)throw new Error("anime is required");const n=dandanplayApi.getSearchEpisodes(e,t),i=await fetchJson(n).catch((e=>(console.log("查询失败:",e),null)));return console.log("查询成功",i),i}async function fetchComment(e){return fetchJson(dandanplayApi.getComment(e,window.ede.chConvert)).then((e=>(console.log("弹幕获取成功: "+e.comments.length),e.comments))).catch((e=>(console.log("弹幕获取失败:",e),null)))}async function fetchExtcommentActual(e,t){if(!e)return null;let n=(await fetchJson(dandanplayApi.getExtcomment(e))).comments;0===n.length&&(n=(await fetchJson(dandanplayApi.getExtcomment(e))).comments),n.map((t=>t.fromUrl=e));const i=window.ede.itemId;return window.ede.extCommentCache[i]||(window.ede.extCommentCache={[i]:{}}),t&&(console.log(`取差集并覆盖: ${e}`),n=n.filter((e=>!t.some((t=>t.cid===e.cid))))),window.ede.extCommentCache[i][e]=n,n}function onPlaybackStop(e,t){if(!t.NowPlayingItem)return console.log("跳过 Web 端自身错误触发的第二次播放停止事件");console.log(e.type);const n=t.PlayState.PositionTicks,i=t.NowPlayingItem.RunTimeTicks;if(!i)return console.log("无可播放时长,跳过处理");const a=parseInt(n/i*100);console.log(`结束播放百分比: ${a}%`);const l=lsGetItem(lsKeys.bangumiPostPercent.id),s=lsGetItem(lsKeys.bangumiToken.id);if(lsGetItem(lsKeys.bangumiEnable.id)&&s&&a>=l&&window.ede.episode_info.episodeId){console.log(`大于需提交的设定百分比: ${l}%`);const{animeTitle:e,episodeTitle:t}=window.ede.episode_info,n=`${e} - ${t}`;putBangumiEpStatus(s).then((e=>{embyToast({text:`putBangumiEpStatus 成功, 目标: ${n}, 结束播放百分比: ${a}%, 大于需提交的设定百分比: ${l}%`}),console.log(`putBangumiEpStatus 成功, 目标: ${n}`)})).catch((e=>{embyToast({text:`putBangumiEpStatus 失败, 目标: ${n}, ${e.message}`}),console.error(`putBangumiEpStatus 失败, 目标: ${n}`,e)}))}}async function getEpisodeBangumiRel(){const e=window.ede.episode_info,t=`_bangumi_episode_id_rel_${e.episodeId}`;let n=localStorage.getItem(t);n&&(n=JSON.parse(n));let i=n?n.bangumiEpsRes:null,a=n?n.subjectId:null,l=n?n.bangumiUrl:null;const s=e.animeId;if(!a){if(!s)throw new Error("未获取到 animeId");const t=await fetchJson(dandanplayApi.getBangumi(s));if(e.bgmEpisodeIndex=offsetBgmEpisodeIndex(e.bgmEpisodeIndex,t.bangumi),l=t.bangumi.bangumiUrl,!l)throw new Error("未请求到 bangumiUrl");a=parseInt(l.match(/\/(\d+)$/)[1])}const o={animeId:s,bangumiUrl:l,subjectId:a,episodeIndex:e?e.episodeIndex:null,bgmEpisodeIndex:e?e.bgmEpisodeIndex:null,bangumiEpsRes:i,_bangumi_key:t};return window.ede.bangumiInfo=o,localStorage.setItem(o._bangumi_key,JSON.stringify(o)),o}function offsetBgmEpisodeIndex(e,t){if(!t)return e;return t.episodes[e]?e:(console.log("未匹配到 danDanPlayBangumi 番剧集数,剧集不为第一季,尝试切换接口数据匹配返回修正后的 bgmEpisodeIndex"),t.episodes.findIndex((t=>t.episodeNumber==e+1)))}async function putBangumiEpStatus(e){const t=await getEpisodeBangumiRel(),{subjectId:n,bgmEpisodeIndex:i}=t,a=i||t.episodeIndex;console.log("准备修改 Bangumi 条目收藏状态为在看, 如果不存在则创建, 如果存在则修改");let l={type:3};if(await fetchJson(bangumiApi.postUserCollection(n),{token:e,body:l}),!t.bangumiEpsRes){const i=bangumiApi.getUserSubjectEpisodeCollection(n),l=await fetchJson(i,{token:e});t.bangumiEpsRes=l;if(!l.data[a])throw new Error("未匹配到 bangumiEpColl")}const s=t.bangumiEpsRes.data[a],o=s.episode;if(2===s.type)throw console.log("Bangumi 已是看过状态,跳过更新",o),new Error("Bangumi 已是看过状态,跳过更新");return console.log("准备更新 Bangumi 章节收藏状态, 详情: ",o),l.type=2,await fetchJson(bangumiApi.putUserEpisodeCollection(o.id),{token:e,body:l,method:"PUT"}),o.type=l.type,console.log("成功更新 Bangumi 章节收藏状态, 在看 => 看过, 详情: ",o),window.ede.bangumiInfo=t,localStorage.setItem(t._bangumi_key,JSON.stringify(t)),t}async function fetchJson(e,t={}){const{token:n,headers:i,body:a}=t;let{method:l="GET"}=t;"GET"===l&&a&&(l="POST");const s={"Accept-Encoding":"gzip",Accept:"application/json","Content-Type":"application/json","User-Agent":navigator.userAgent};n&&(s.Authorization=`Bearer ${n}`),i&&Object.assign(s,i);const o=a?JSON.stringify(a):null;try{const t=await fetch(e,{method:l,headers:s,body:o});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const n=await t.text();if(n.length>0)try{return JSON.parse(n)}catch(e){console.warn("responseText not is JSON:",e)}return{success:!0}}catch(e){throw e}}async function getMapByEmbyItemInfo(){let e,t,n=await getEmbyItemInfo();if(n||(n=await fatchEmbyItemInfo(window.ede.itemId)),!n)return null;if(!["Episode","Movie"].includes(n.Type))return console.error("不支持的类型");window.ede.itemId=n.Id;let i,a=-1;if("Episode"==n.Type){e=n.SeasonId,t=n.SeriesName,i=n.IndexNumber;let a=n.ParentIndexNumber;1!=a&&(t+=" "+a)}else e=n.Id,t=n.Name,i="movie";let l="_anime_id_rel_"+e,s="_anime_season_rel_"+e,o="_episode_id_rel_"+e+"_"+i;return window.localStorage.getItem(l)&&(a=window.localStorage.getItem(l)),{_id:e,_id_key:l,_season_key:s,_episode_key:o,animeId:a,episode:i,animeName:t,seriesOrMovieId:n.SeriesId||n.Id}}async function lsSeasonSearchEpisodes(e,t){const n=window.localStorage.getItem(e);if(!n)return null;const i=JSON.parse(n);let a=1/0,l=null;for(let e=0;e<i.length;e++){const n=i[e],s=t+n.episodeOffset;s>0&&s<a&&(a=s,l=n)}if(l){const e=t+l.episodeOffset;console.log(`命中seasonInfo缓存: ${l.name},偏移量: ${l.episodeOffset},集: ${e}`);return{animaInfo:await fetchSearchEpisodes(l.name,e),newEpisode:e}}return null}async function autoFailback(e,t,n){console.log("自动匹配未查询到结果,可能为非番剧,将移除章节过滤,重试一次");let i=await fetchSearchEpisodes(e);if(i.animes.length>0){console.log("移除章节过滤,自动匹配成功,转换为目标章节索引 0"),isNaN(t)&&(t=0);const n=i.animes[0].episodes[t];return n?(i.animes[0].episodes=[n],{animeName:e,animaInfo:i}):null}const a=await ApiClient.getItem(ApiClient.getCurrentUserId(),n);if(!a.OriginalTitle)return null;console.log(`标题名: ${e},自动匹配未查询到结果,将使用原标题名,重试一次`);const l=a.OriginalTitle;return i=await fetchSearchEpisodes(l,t),i.animes.length<1?null:(console.log(`使用原标题名: ${l},自动匹配成功`),{animeName:e,animeOriginalTitle:l,animaInfo:i})}async function searchEpisodes(e){const{_season_key:t,animeName:n,episode:i,seriesOrMovieId:a}=e;console.log(`[自动匹配] 标题名: ${n}`+(i?`,章节过滤: ${i}`:""));let l,s=await lsSeasonSearchEpisodes(t,i);if(s){l=s.animaInfo;const e=s.newEpisode-1;if(l&&l.animes.length>0)return{animeOriginalTitle:"",animaInfo:l,bgmEpisodeIndex:e}}if(l=await fetchSearchEpisodes(n,i),l&&l.animes.length>0)return{animeOriginalTitle:"",animaInfo:l};const o=await autoFailback(n,i,a);return o||void 0}async function getEpisodeInfo(e=!0){const t=await getMapByEmbyItemInfo();if(!t)return null;const{_episode_key:n,animeId:i,episode:a}=t;if(e&&window.localStorage.getItem(n))return JSON.parse(window.localStorage.getItem(n));const l=await searchEpisodes(t);if(!l||0===l.animaInfo.animes.length)return console.log("弹弹 Play 章节匹配失败"),appendvideoOsdDanmakuInfo(),null;const{animeOriginalTitle:s,animaInfo:o}=l;let d=1;if(-1!=i)for(let e=0;e<o.animes.length;e++)o.animes[e].animeId==i&&(d=e+1);d=parseInt(d)-1;const r=isNaN(a)?0:a-1,m={episodeId:o.animes[d].episodes[0].episodeId,episodeTitle:o.animes[d].episodes[0].episodeTitle,episodeIndex:r,bgmEpisodeIndex:l.bgmEpisodeIndex?l.bgmEpisodeIndex:r,animeId:o.animes[d].animeId,animeTitle:o.animes[d].animeTitle,animeOriginalTitle:s};return localStorage.setItem(n,JSON.stringify(m)),m}async function getCommentsByPluginApi(e){const t=`${ApiClient.serverAddress()}/api/danmu/${e}/raw?X-Emby-Token=${ApiClient.accessToken()}`,n=await fetch(t);if(!n.ok)return null;const i=await n.text();if(!i||0===i.length)return null;try{const e=(new DOMParser).parseFromString(i,"text/xml"),t=[];for(const n of e.getElementsByTagName("d")){const e=n.getAttribute("p").split(",").map(Number),i={cid:e[7],p:e[0]+","+e[1]+","+e[3]+","+e[6],m:n.textContent};t.push(i)}return t}catch(e){return console.error("Failed to parse XML data:",e),null}}async function refreshPluginXml(e){const t=`${ApiClient.serverAddress()}/api/danmu/${e}?option=Refresh&X-Emby-Token=${ApiClient.accessToken()}`;if(!(await fetch(t)).ok)throw new Error(lsKeys.refreshPluginXml.name+":失败");console.log(lsKeys.refreshPluginXml.name+":成功")}async function createDanmaku(e){if(!e)return;null!=window.ede.danmaku&&(window.ede.danmaku.destroy(),window.ede.danmaku=null);const t=danmakuParser(e);window.ede.commentsParsed=t;let n=danmakuFilter(t);console.log("弹幕加载成功: "+n.length);const i=document.querySelector(mediaContainerQueryStr),a=document.querySelector(mediaQueryStr);if(!a)throw window.ede.danmaku||(window.ede.danmaku={comments:n}),buildCurrentDanmakuInfo(currentDanmakuInfoContainerId),new Error("用户已退出视频播放");isVersionOld||(a.style.position="absolute");let l=getById(eleIds.danmakuWrapper);l&&l.remove(),l=document.createElement("div"),l.id=eleIds.danmakuWrapper,l.style.position="fixed",l.style.width="100%",l.style.height=`calc(${lsGetItem(lsKeys.heightPercent.id)}% - 0px)`,l.style.backgroundColor=lsGetItem(lsKeys.debugShowDanmakuWrapper.id)?styles.colors.highlight:"",l.style.top="0px",l.style.pointerEvents="none",i.prepend(l);let s=144*lsGetItem(lsKeys.speed.id);window.ede.danmaku=new Danmaku({container:l,media:a,comments:n,engine:lsGetItem(lsKeys.engine.id),speed:s}),lsGetItem(lsKeys.switch.id)?window.ede.danmaku.show():window.ede.danmaku.hide(),window.ede.ob&&window.ede.ob.disconnect(),window.ede.ob=new ResizeObserver((()=>{window.ede.danmaku&&(console.log("Resizing"),window.ede.danmaku.resize(),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20))})),window.ede.ob.observe(i),a.id&&require(["playbackManager"],(e=>{e.getPlayerState().PlayState.IsPaused&&a.dispatchEvent(new Event("pause"))})),buildCurrentDanmakuInfo(currentDanmakuInfoContainerId),appendvideoOsdDanmakuInfo(n.length),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20)}function buildProgressBarChart(e){const t=getById(eleIds.progressBarLineChart);t&&t.remove();const n=window.ede.danmaku?window.ede.danmaku.comments:[],i=getByClass(classes.videoOsdPositionSliderContainer);if(!n||!i||n&&0===n.length)return;const a=i.offsetWidth;console.log("progressBarWidth: "+a);const l=document.createElement("canvas");l.id=eleIds.progressBarLineChart,l.width=a,l.height=e,l.style.position="absolute",l.style.top=OS.isEmbyNoisyX()?"-24px":"-21px",i.prepend(l);const s=l.getContext("2d"),o=Math.max(...n.map((e=>e.time))),d=Array.from({length:Math.ceil(o/1)},(()=>0));n.forEach((e=>{const t=Math.floor(e.time/1);t<d.length&&d[t]++})),function(t){s.clearRect(0,0,a,e);const n=Math.max(...t),i=e/n;s.beginPath(),s.moveTo(0,e-t[0]*i);for(let n=1;n<t.length;n++){const l=n/(t.length-1)*a,o=e-t[n]*i;s.lineTo(l,o)}s.strokeStyle="rgba(255, 255, 255, 0.6)",s.lineWidth=2,s.stroke()}(d),console.log("已重绘进度条弹幕数量折线图")}function loadDanmaku(e=LOAD_TYPE.CHECK){if(!document.querySelector(mediaQueryStr))return console.warn("用户已退出视频播放,停止加载弹幕");window.ede.loading?console.log("正在重新加载"):(window.ede.loading=!0,lsGetItem(lsKeys.useFetchPluginXml.id)?getMapByEmbyItemInfo().then((t=>{getCommentsByPluginApi(window.ede.itemId).then((e=>{if(e&&e.length>0)return createDanmaku(e).then((()=>{console.log(lsKeys.useFetchPluginXml.name+":就位")})).then((()=>{window.ede.loading=!1;const t=getById(eleIds.danmakuCtr);t&&"1"!==t.style.opacity&&(t.style.opacity="1");const n=getById(eleIds.videoOsdDanmakuTitle);n&&n.innerText.includes("未匹配")&&(n.innerText=`弹幕：${lsKeys.useFetchPluginXml.name} - ${e.length}条`)})).catch((e=>{console.error(e),console.error("useFetchPluginXml createDanmaku error")}));throw new Error(lsKeys.useFetchPluginXml.name+"失败,尝试在线加载")})).catch((t=>(console.error(t),loadOnlineDanmaku(e))))})):loadOnlineDanmaku(e))}function loadOnlineDanmaku(e){getEpisodeInfo(e!==LOAD_TYPE.SEARCH).then((t=>new Promise(((n,i)=>{t||(e!==LOAD_TYPE.INIT?i("播放器未完成加载"):i(null)),e!==LOAD_TYPE.SEARCH&&e!==LOAD_TYPE.REFRESH&&e!==LOAD_TYPE.RELOAD&&e!==LOAD_TYPE.INIT&&window.ede.danmaku&&window.ede.episode_info&&window.ede.episode_info.episodeId==t.episodeId?i("当前播放视频未变动"):(window.ede.episode_info=t,n(t.episodeId))})))).then((t=>{t&&(e===LOAD_TYPE.RELOAD&&window.ede.danmuCache[t]?createDanmaku(window.ede.danmuCache[t]).then((()=>{console.log("弹幕就位")})).catch((e=>{console.log(e)})):fetchComment(t).then((e=>{window.ede.danmuCache[t]=e,createDanmaku(e).then((()=>{console.log("弹幕就位")})).catch((e=>{console.log(e)}))})))}),(e=>{e&&console.log(e)})).then((()=>{objectEntries(window.ede.extCommentCache[window.ede.itemId]||{}).forEach((([e,t])=>{addExtComments(e,t)})),window.ede.loading=!1;const e=getById(eleIds.danmakuCtr);e&&"1"!==e.style.opacity&&(e.style.opacity="1")})).catch((e=>{console.log(e)}))}function danmakuFilter(e){let t=[...e];return danmakuAutoFilter(t),t=danmakuTypeFilter(t),t=danmakuSourceFilter(t),t=danmakuDensityLevelFilter(t),t=danmakuKeywordsFilter(t),t=danmakuMergeSimilar(t,lsGetItem(lsKeys.mergeSimilarPercent.id),lsGetItem(lsKeys.mergeSimilarTime.id)),t}function danmakuAutoFilter(e){const t=lsGetItem(lsKeys.autoFilterCount.id);if(0==t||e.length<t)return danmakuAutoFilterCancel();let n=`检测到 ${e.length} 条弹幕 > ${lsKeys.autoFilterCount.name}:${t},准备开始自动过滤(单集有效)`;const i=n.length,a=lsGetItem(lsKeys.heightPercent.id);a>90&&(window.ede.tempLsValues[lsKeys.heightPercent.id]=a,lsSetItem(lsKeys.heightPercent.id,90),n+=`\n已自动调整 ${lsKeys.heightPercent.name}:90`);const l=lsGetItem(lsKeys.typeFilter.id);if(!l.includes(danmakuTypeFilterOpts.bottom.id)){window.ede.tempLsValues[lsKeys.typeFilter.id]=l;const e=[...l,danmakuTypeFilterOpts.bottom.id];lsSetItem(lsKeys.typeFilter.id,e),n+=`\n已自动添加 ${lsKeys.typeFilter.name}:${danmakuTypeFilterOpts.bottom.name}`}const s=lsGetItem(lsKeys.mergeSimilarEnable.id);s||(window.ede.tempLsValues[lsKeys.mergeSimilarEnable.id]=s,lsSetItem(lsKeys.mergeSimilarEnable.id,!0),n+=`\n已自动调整 ${lsKeys.mergeSimilarEnable.name}:true`),n.length!=i&&(embyToast({text:n}),console.log(n))}function danmakuAutoFilterCancel(){Object.keys(window.ede.tempLsValues).length>0&&(objectEntries(window.ede.tempLsValues).forEach((([e,t])=>lsSetItem(e,t))),window.ede.tempLsValues={},console.log("从临时值恢复用户值并重置"))}function danmakuTypeFilter(e){let t=lsGetItem(lsKeys.typeFilter.id);return t.includes(danmakuTypeFilterOpts.onlyWhite.id)&&(e=e.filter((e=>"#ffffff"===e.style.color.toLowerCase().slice(0,7))),t.splice(t.indexOf(danmakuTypeFilterOpts.onlyWhite.id),1)),t.includes(danmakuTypeFilterOpts.rolling.id)&&(e=e.filter((e=>danmakuTypeFilterOpts.ltr.id!==e.mode&&danmakuTypeFilterOpts.rtl.id!==e.mode)),t.splice(t.indexOf(danmakuTypeFilterOpts.rolling.id),1)),t.includes(danmakuTypeFilterOpts.emoji.id)&&(e=e.filter((e=>!emojiRegex.test(e.text))),t.splice(t.indexOf(danmakuTypeFilterOpts.emoji.id),1)),t.length>0&&(e=e.filter((e=>!t.includes(e.mode)))),e}function danmakuSourceFilter(e){return e.filter((e=>!lsGetItem(lsKeys.sourceFilter.id).includes(e.source)))}function danmakuDensityLevelFilter(e){let t=lsGetItem(lsKeys.filterLevel.id);if(0==t)return e;let n=9-2*t,i=[],a=[];for(let t=0;t<e.length;t++){let l=e[t],s=Math.ceil(l.time),o=Math.ceil(l.time/3);i[s]||(i[s]=[]),a[o]||(a[o]=[]),a[o].length<6?a[o].push(l):l.mode="rtl",i[s].length<n&&i[s].push(l)}return i.flat()}function danmakuKeywordsFilter(e){if(!lsGetItem(lsKeys.filterKeywordsEnable.id))return e;const t=lsGetItem(lsKeys.filterKeywords.id).split(/\r?\n/).map((e=>e.trim())).filter((e=>e.length>0&&!e.startsWith("// ")));if(0===t.length)return e;const n=["text",...Object.keys(showSource)];return e.filter((e=>!t.some((t=>{try{return n.some((n=>new RegExp(t).test(e[n])))}catch(i){return n.some((n=>e[n].includes(t)))}}))))}function danmakuMergeSimilar(e,t=50,n=15){if(!lsGetItem(lsKeys.mergeSimilarEnable.id))return e;const i=[],a=[],l=(new Date).getTime();for(let l=0;l<e.length;l++){if(a.includes(l))continue;let s=e[l],o=1,d=0;for(let i=l+1;i<e.length&&Math.abs(e[i].time-e[l].time)<=n;i++){if(a.includes(i))continue;const n=similarityPercentage(s.text,e[i].text);n>=t&&(o++,a.push(i),d+=n)}o>1&&(s.text+=` [x${o}]`,s.xCount=o,s.xTotalSimilarity=d/o),i.push(s)}const s=(new Date).getTime();return console.log(`danmakuMergeSimilar 耗时: ${s-l} 毫秒`),i}function similarityPercentage(e,t){if(e===t)return 100;e.length>t.length&&([e,t]=[t,e]);let n=Array.from({length:e.length+1},((e,t)=>t)),i=Array(e.length+1);for(let a=1;a<=t.length;a++){i[0]=a;for(let l=1;l<=e.length;l++){const s=e[l-1]===t[a-1]?0:1,o=n[l]+1,d=i[l-1]+1;i[l]=Math.min(n[l-1]+s,o,d)}[n,i]=[i,n]}const a=n[e.length],l=Math.max(e.length,t.length);return(l-a)/l*100}function danmakuParser(e){const t=lsGetItem(lsKeys.fontSizeRate.id);let n=25;const i=getByClass(classes.videoOsdTitle);n=i?parseFloat(getComputedStyle(i).fontSize.replace("px",""))*t:Math.round(18*(window.screen.height>window.screen.width?window.screen.width:window.screen.height/1080)*t);const a=lsGetItem(lsKeys.fontWeight.id),l=styles.fontStyles[lsGetItem(lsKeys.fontStyle.id)].id,s=lsGetItem(lsKeys.fontFamily.id),o=Math.round(255*lsGetItem(lsKeys.fontOpacity.id)).toString(16).padStart(2,"0"),d=lsGetItem(lsKeys.timelineOffset.id),r=/\[(.*)\](.*)/,m=lsGetItem(lsKeys.showSource.id);return e.map((e=>{const t=e.p.split(","),i={6:"ltr",1:"rtl",5:"top",4:"bottom"}[t[1]];if(!i)return null;const c=Number(t[2]).toString(16).padStart(6,"0"),u=`${c}${o}`,y="000000"===c?`#ffffff${o}`:`#000000${o}`,g=t[3].match(r),b=g&&g[1]?g[1]:danmakuSource.DanDanPlay.id,p=g&&g[2]?g[2]:t[3],h={text:e.m,mode:i,time:1*t[0]+d,style:getCommentStyle(u,y,l,a,n,s),[showSource.cid.id]:e.cid,[showSource.source.id]:b,[showSource.originalUserId.id]:p};return m.length>0&&(h.originalText=h.text,h.text+=m.map((e=>e===showSource.source.id?`,[${h[e]}]`:","+h[e])).join("")),h.cuid=h[showSource.cid.id]+","+h[showSource.originalUserId.id],h})).filter((e=>e)).sort(((e,t)=>e.time-t.time))}function getCommentStyle(e,t,n,i,a,l){return{color:`#${e}`,textShadow:`-1px -1px ${t}, -1px 1px ${t}, 1px -1px ${t}, 1px 1px ${t}`,font:`${n} ${i} ${a}px ${l}`,fillStyle:`#${e}`,strokeStyle:t,lineWidth:2}}function toastByDanmaku(e,t){e=toastPrefixes.system+e;const n=1.5*parseFloat(getComputedStyle(getByClass(classes.videoOsdTitle)).fontSize.replace("px","")),i=styles.colors[t],a=document.querySelector(mediaQueryStr).currentTime,l="ff",s=`000000${i.toString(16)}${l}`.slice(-8),o={text:e,mode:"top",time:a,style:{fontSize:`${n}px`,color:`#${s}`,textShadow:"00000"===s?"-1px -1px #fff, -1px 1px #fff, 1px -1px #fff, 1px 1px #fff":"-1px -1px #000, -1px 1px #000, 1px -1px #000, 1px 1px #000",font:`${n}px sans-serif`,fillStyle:`#${s}`,strokeStyle:"000000"===s?`#ffffff${l}`:`#000000${l}`,lineWidth:2}};window.ede.danmaku.emit(o)}function createDialog(){require(["emby-select","emby-checkbox","emby-slider","emby-textarea","emby-collapse","emby-button"]);embyDialog({html:`<div id="${eleIds.dialogContainer}"></div>`,buttons:[{name:"关闭"}]}),waitForElement("#"+eleIds.dialogContainer,afterEmbyDialogCreated)}async function afterEmbyDialogCreated(e){const t=await getMapByEmbyItemInfo();t&&(window.ede.searchDanmakuOpts={_id_key:t._id_key,_season_key:t._season_key,_episode_key:t._episode_key,animeId:t.animeId,animeName:t.animeName,seriesOrMovieId:t.seriesOrMovieId,episode:(parseInt(t.episode)||1)-1,animes:[]});let n=getByClass(classes.formDialogHeader);const i=getByClass(classes.formDialogFooter);n=n||e;const a=document.createElement("div");a.className=classes.embyTabsMenu,a.append(embyTabs(danmakuTabOpts,danmakuTabOpts[0].id,"id","name",(e=>{danmakuTabOpts.forEach((t=>{const n=getById(t.id);n&&(n.hidden=t.id!==e.id)}))}))),n.append(a),n.style="width: 100%; padding: 0; height: auto;",danmakuTabOpts.forEach(((t,n)=>{const i=document.createElement("div");i.id=t.id,i.style.textAlign="left",i.hidden=0!=n,e.append(i);try{t.buildMethod(t.id)}catch(e){console.error(e)}})),i&&(i.style.padding="0.3em")}function buildDanmakuSetting(e){const t=getById(e);let n=`\n            <div style="display: flex; justify-content: center;">\n                <div>\n                    <div id="${eleIds.danmakuSwitchDiv}" style="margin-bottom: 0.2em;">\n                        <label class="${classes.embyLabel}">${lsKeys.switch.name} </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.filterLevel.name}: </label>\n                        <div id="${eleIds.filterLevelDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label style="${styles.embySliderLabel}">0</label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.heightPercent.name}: </label>\n                        <div id="${eleIds.heightPercentDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label style="${styles.embySliderLabel}"></label>\n                            <label>%</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontSizeRate.name}: </label>\n                        <div id="${eleIds.danmakuSizeDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label style="${styles.embySliderLabel}"></label>\n                            <label>倍</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontOpacity.name}: </label>\n                        <div id="${eleIds.danmakuOpacityDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label style="${styles.embySliderLabel}"></label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.speed.name}: </label>\n                        <div id="${eleIds.danmakuSpeedDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label style="${styles.embySliderLabel}"></label>\n                            <label>倍</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.timelineOffset.name}: </label>\n                        <div id="${eleIds.timelineOffsetDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label style="${styles.embySliderLabel}"></label>\n                    </div>\n                    <div is="emby-collapse" title="弹幕字体样式" data-expanded="false">\n                        <div class="${classes.collapseContentNav}">\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontWeight.name}: </label>\n                                <div id="${eleIds.danmakuFontWeightDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label style="${styles.embySliderLabel}"></label>\n                            </div>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontStyle.name}: </label>\n                                <div id="${eleIds.danmakuFontStyleDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label style="${styles.embySliderLabel}">正常</label>\n                            </div>\n                            <div id="${eleIds.fontFamilyCtrl}" style="margin: 0.6em 0;"></div>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontFamily.name}: </label>\n                                <div id="${eleIds.fontFamilyDiv}" class="${classes.embySelectWrapper}"></div>\n                                <label id="${eleIds.fontFamilyLabel}" style="width: 10em; margin-left: 1em;"></label>\n                            </div>\n                            <div style="max-width: 31.5em;">\n                                <label class="${classes.embyLabel}" style="width: 5em;">弹幕外观: </label>\n                                <div id="${eleIds.fontStylePreview}"\n                                    class="flex justify-content-center"\n                                    style="border: .08em solid gray;color: black;border-radius: .24em;padding: .5em;;background-color: #6a96bd;">\n                                    简中/繁體/English/こんにちはウォルド/</br>\n                                    ABC/abc/012/~!@<?>[]/《？》【】</br>\n                                    ☆*: .｡. o(≧▽≦)o .｡.:*☆</br>\n                                    emoji:😆👏🎈🍋🌞⁉️🎉</br>\n                                </div>\n                                <div class="${classes.embyFieldDesc}">\n                                    这些设置会影响此设备上的弹幕外观,此处固定为 dom 引擎,\n                                    canvas 引擎效果一样,此处不做切换展示,\n                                    因为弹幕大小是根据播放页次标题动态计算的,此处不做参考,\n                                    选择或输入的字体是否有效取决于设备本身的字体库,没有网络加载\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="${eleIds.settingsCtrl}" style="margin: 0.6em 0;"></div>\n                    <textarea id="${eleIds.settingsText}" style="display: none;resize: vertical;width: 100%" rows="20"\n                        is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),getById(eleIds.danmakuSwitchDiv,t).prepend(embyButton({id:eleIds.danmakuSwitch,label:"弹幕开关",iconKey:lsGetItem(lsKeys.switch.id)?iconKeys.switch_on:iconKeys.switch_off,style:(lsGetItem(lsKeys.switch.id)?"color:#52b54b;":"")+"font-size:1.5em;padding:0;"},doDanmakuSwitch)),getById(eleIds.filterLevelDiv,t).append(embySlider({lsKey:lsKeys.filterLevel},onSliderChange,onSliderChangeLabel)),getById(eleIds.heightPercentDiv,t).append(embySlider({lsKey:lsKeys.heightPercent},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuSizeDiv,t).append(embySlider({lsKey:lsKeys.fontSizeRate},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuOpacityDiv,t).append(embySlider({lsKey:lsKeys.fontOpacity},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuSpeedDiv,t).append(embySlider({lsKey:lsKeys.speed},onSliderChange,onSliderChangeLabel));const i=getById(eleIds.timelineOffsetDiv,t),a={lsKey:lsKeys.timelineOffset};onSliderChangeLabel(lsGetItem(lsKeys.timelineOffset.id),a),timeOffsetBtns.forEach((e=>{i.append(embyButton(e,(e=>{if(e.target){let t=lsGetItem(lsKeys.timelineOffset.id),n=t+(parseFloat(e.target.getAttribute("valueOffset"))||0);n===t&&(n=0),onSliderChange(n,a)}})))})),buildFontStyleSetting(t),buildSettingsBackup(t)}function buildSettingsBackup(e){const t=getById(eleIds.settingsCtrl,e);t.append(embyButton({label:"配置",iconKey:iconKeys.more},(e=>{const t=!e.target.xChecked;e.target.xChecked=t,e.target.title=t?"关闭":"配置",e.target.firstChild.innerHTML=t?iconKeys.close:iconKeys.more;const n=getById(eleIds.settingsText);n.style.display=t?"":"none",t&&(n.value=getSettingsJson(2)),[eleIds.settingReloadBtn,eleIds.settingsImportBtn].forEach((e=>{getById(e).style.display=t?"":"none"}))}))),t.append(embyButton({id:eleIds.settingReloadBtn,label:"刷新",iconKey:iconKeys.refresh,style:"display: none;"},(()=>getById(eleIds.settingsText).value=getSettingsJson(2)))),t.append(embyButton({id:eleIds.settingsImportBtn,label:"应用",iconKey:iconKeys.done,style:"display: none;"},(()=>{lsBatchSet(JSON.parse(getById(eleIds.settingsText).value)),loadDanmaku(LOAD_TYPE.INIT),closeEmbyDialog()})))}function buildFontStyleSetting(){getById(eleIds.danmakuFontWeightDiv).append(embySlider({lsKey:lsKeys.fontWeight},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuFontStyleDiv).append(embySlider({lsKey:lsKeys.fontStyle},((e,t)=>onSliderChange(styles.fontStyles[e].name,t)),((e,t)=>onSliderChangeLabel(styles.fontStyles[e].name,t)))),buildFontFamilySetting()}function buildFontFamilySetting(){const e=lsGetItem(lsKeys.fontFamily.id);let t=[{family:lsKeys.fontFamily.defaultValue,fullName:lsKeys.fontFamily.defaultValue},{family:"Consolas",fullName:"Consolas"},{family:"SimHei",fullName:"黑体"},{family:"SimSun",fullName:"宋体"},{family:"KaiTi",fullName:"楷体"},{family:"Microsoft YaHei",fullName:"微软雅黑"}];"queryLocalFonts"in window?queryLocalFonts().then((n=>{t=[...t,...n].reduce(((e,t)=>(e.some((e=>e.family===t.family))||e.push(t),e)),[]);resetFontFamilyDiv(t.findIndex((t=>t.family===e)),t)})).catch((e=>{console.error(e)})):console.info("queryLocalFonts 高级查询 API 不可用,使用预定字体列表");resetFontFamilyDiv(t.findIndex((t=>t.family===e)),t),buildFontFamilyCtrl()}function buildFontFamilyCtrl(){const e=getById(eleIds.fontFamilyCtrl);e.append(embyButton({label:"切换手填",iconKey:iconKeys.edit},(e=>{const t=!e.target.xChecked;e.target.xChecked=t,e.target.title=t?"手填":"选择",getById(eleIds.fontFamilySelect).style.display=t?"none":"",getById(eleIds.fontFamilyInput).style.display=t?"":"none",t&&(getById(eleIds.fontFamilyLabel).innerHTML="")}))),e.append(embyButton({label:"重置为默认",iconKey:iconKeys.refresh},(()=>{lsCheckSet(lsKeys.fontFamily.id,lsKeys.fontFamily.defaultValue)&&(changeFontStylePreview(),onSliderChangeLabel(lsKeys.fontFamily.defaultValue,{labelId:eleIds.fontFamilyLabel}),getById(eleIds.fontFamilyInput).value=lsGetItem(lsKeys.fontFamily.id),loadDanmaku(LOAD_TYPE.RELOAD))})))}function resetFontFamilyDiv(e,t){const n=getById(eleIds.fontFamilyDiv);n.innerHTML="",n.append(embySelect({id:eleIds.fontFamilySelect,label:`${lsKeys.fontFamily.name}: `},e,t,"family","family",((e,t,n)=>{if(console.log("fontFamilyDivChange: ",e,t,n),lsCheckSet(lsKeys.fontFamily.id,e)){changeFontStylePreview();onSliderChangeLabel(n.family!==n.fullName?n.fullName:"",{labelId:eleIds.fontFamilyLabel}),loadDanmaku(LOAD_TYPE.RELOAD)}}))),n.append(embyInput({id:eleIds.fontFamilyInput,value:lsGetItem(lsKeys.fontFamily.id),type:"search",style:"display: none;"},(e=>{const t=getTargetInput(e).value.trim();t&&lsCheckSet(lsKeys.fontFamily.id,t)&&(changeFontStylePreview(),loadDanmaku(LOAD_TYPE.RELOAD))}))),changeFontStylePreview();const i=t.find((e=>e.family===lsGetItem(lsKeys.fontFamily.id)));onSliderChangeLabel(i?i.fullName:"",{labelId:eleIds.fontFamilyLabel})}function loadLocalFont(e){new FontFace(e,`local("${e}")`).load().then((t=>{document.fonts.add(t),console.log(`The local font "${e}" has been added under the name "${e}"`)})).catch((t=>{console.error(`Failed to load or add the local font "${e}"`,t)}))}function changeFontStylePreview(){const e=getById(eleIds.fontStylePreview),t=lsGetItem(lsKeys.fontWeight.id),n=styles.fontStyles[lsGetItem(lsKeys.fontStyle.id)].id,i=lsGetItem(lsKeys.fontFamily.id),a=Math.round(255*lsGetItem(lsKeys.fontOpacity.id)).toString(16).padStart(2,"0"),l=Number(styles.colors.info).toString(16).padStart(6,"0"),s=`${l}${a}`,o="000000"===l?`#ffffff${a}`:`#000000${a}`,d=e.previousElementSibling,r=getCommentStyle(s,o,n,t,parseFloat(getComputedStyle(d).fontSize.replace("px","")),i);Object.assign(e.style,r)}function buildSearchEpisode(e){const t=getById(e),n=window.ede.episode_info?window.ede.episode_info.episodeId:null,i=window.ede.danmuCache[n]||[];let a=`\n            <div>\n                <div>\n                    <label class="${classes.embyLabel}">标题: </label>\n                    <div id="${eleIds.danmakuSearchNameDiv}" style="display: flex;"></div>\n                </div>\n                <div id="${eleIds.danmakuEpisodeFlag}" hidden>\n                    <div style="display: flex;">\n                        <div style="width: 80%;">\n                            <label class="${classes.embyLabel}">媒体名: </label>\n                            <div id="${eleIds.danmakuAnimeDiv}" class="${classes.embySelectWrapper}"></div>\n                            <label class="${classes.embyLabel}">分集名: </label>\n                            <div style="display: flex;">\n                                <div id="${eleIds.danmakuEpisodeNumDiv}" style="max-width: 90%;" class="${classes.embySelectWrapper}"></div>\n                                <div id="${eleIds.danmakuEpisodeLoad}"></div>\n                            </div>\n                        </div>\n                        <img id="${eleIds.searchImg}" style="width: 20%;height: 100%;margin: 2%;"\n                            loading="lazy" decoding="async" draggable="false" class="coveredImage-noScale"></img>\n                        </div>\n                    </div>\n                <div hidden>\n                    <label class="${classes.embyLabel}" id="${eleIds.danmakuRemark}"></label>\n                </div>\n                <div>\n                    <h4>匹配源</h4>\n                    <div>\n                        <div id="${eleIds.currentMatchedDiv}">\n                            <label class="${classes.embyLabel}">弹弹 play 总量: ${i.length}</label>\n                        </div>\n                        <label class="${classes.embyLabel}">弹弹 play 附加的第三方 url: </label>\n                    </div>\n                    <div id="${eleIds.extUrlsDiv}"></div>\n                </div>\n                <div is="emby-collapse" title="附加弹幕">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">弹弹 play 支持解析的第三方 url: </label>\n                        <div id="${eleIds.extCommentSearchDiv}" style="display: flex;"></div>\n                        <div class="${classes.embyFieldDesc}">\n                            原接口文档说明支持(如A/B/C站),自测另外支持[ 爱奇艺视频, 腾讯视频, 优酷视频, ],不支持[ 芒果 TV, ]\n                        </div>\n                        <div class="${classes.embyFieldDesc}">\n                            仅[ 爱奇艺视频, ]需要注意网址后不能带 ? 的参数,其余网址带不带都可以\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="服务端 Danmu 插件">\n                    <div class="${classes.collapseContentNav}">\n                        <div id="${eleIds.danmuPluginDiv}" class="${classes.embyCheckboxList}" style="${styles.embyCheckboxList}"></div>\n                    </div>\n                </div>\n            </div>\n        `;t.innerHTML=a.trim(),buildSearchEpisodeEle(),buildExtCommentDiv(),buildDanmuPluginDiv()}function buildSearchEpisodeEle(){const e=getById(eleIds.danmakuSearchNameDiv);e.append(embyInput({id:eleIds.danmakuSearchName,value:window.ede.searchDanmakuOpts.animeName,type:"search"},doDanmakuSearchEpisode)),e.append(embyButton({label:"搜索",iconKey:iconKeys.search},doDanmakuSearchEpisode)),e.append(embyButton({label:"切换[原]标题",iconKey:iconKeys.text_format},doSearchTitleSwtich)),getById(eleIds.danmakuEpisodeLoad).append(embyButton({id:eleIds.danmakuSwitchEpisode,label:"加载弹幕",iconKey:iconKeys.done},doDanmakuSwitchEpisode));const t=getById(eleIds.currentMatchedDiv);t.append(embyButton({label:"取消匹配/清空弹幕",iconKey:iconKeys.close},(e=>{window.ede.episode_info&&window.ede.episode_info.episodeId&&(window.ede.episode_info.episodeId=null),window.ede.danmaku&&createDanmaku([]),t.querySelector("label").textContent="弹弹 play 总量: 0"})))}function buildExtCommentDiv(){const e=getById(eleIds.extCommentSearchDiv);buildExtUrlsDiv(),e.append(embyInput({type:"search",placeholder:"http(s)://"},onEnterExtComment)),e.append(embyButton({label:"搜索",iconKey:iconKeys.search},onEnterExtComment))}function buildExtUrlsDiv(){const e=window.ede.episode_info?window.ede.episode_info.episodeId:null,t=window.ede.danmuCache[e]||[],n=window.ede.extCommentCache[window.ede.itemId],i=t.concat(...Object.values(n||{})),a=getById(eleIds.extUrlsDiv);a.innerHTML="",n&&objectEntries(n).forEach((([e,t])=>{const l=document.createElement("div");l.append(embyButton({label:"清空此加载",iconKey:iconKeys.close},(t=>{delete n[e],t.target.parentNode.remove(),createDanmaku(i.filter((t=>t.fromUrl!==e)))}))),l.append(embyALink(e),document.createTextNode(` 总量: ${t.length}`)),a.append(l)}))}async function onEnterExtComment(e){const t=getTargetInput(e).value.trim();if(!t.startsWith("http"))return embyToast({text:"输入的 url 应以 http 开头!"});addExtComments(t)}async function addExtComments(e,t){const n=window.ede.episode_info,i=n?n.episodeId:null,a=window.ede.danmuCache[i]||[];if(t||(t=await fetchExtcommentActual(e,a)),0===t.length)return embyToast({text:"附加弹幕不能为空!"});const l=a.concat(t);createDanmaku(l).then((()=>{const e=window.ede.commentsParsed.length-t.length;embyToast({text:`此次附加总量: ${t.length}, 附加前总量: ${e}, 附加后总量: ${l.length}`}),console.log(`附加弹幕就位, 附加前总量: ${e}`),buildExtUrlsDiv()})).catch((e=>console.log(e)))}function buildDanmuPluginDiv(){getById(eleIds.danmuPluginDiv).append(embyCheckbox({label:lsKeys.useFetchPluginXml.name},lsGetItem(lsKeys.useFetchPluginXml.id),(e=>{lsSetItem(lsKeys.useFetchPluginXml.id,e)})))}function buildCurrentDanmakuInfo(e){const t=getById(e);if(!t)return;const{episodeTitle:n,animeId:i,animeTitle:a}=window.ede.episode_info||{},l=getDanmakuComments(window.ede).length,s=window.ede.commentsParsed.length;let o=`\n            <div style="display: flex;">\n                <div id="${eleIds.posterImgDiv}"></div>\n                <div>\n                    <div>\n                        <label class="${classes.embyLabel}">媒体名: </label>\n                        <div class="${classes.embyFieldDesc}">${a}</div>\n                    </div>\n                    ${n?`<div>\n                        <label class="${classes.embyLabel}">章节名: </label>\n                        <div class="${classes.embyFieldDesc}">${n}</div>\n                    </div>`:""}\n                    <div>\n                        <label class="${classes.embyLabel}">其它信息: </label>\n                        <div class="${classes.embyFieldDesc}">\n                            获取总数: ${s},\n                            加载总数: ${l},\n                            被过滤数: ${s-l}\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div style="margin-top: 2%;">\n                <label class="${classes.embyLabel}">${lsKeys.danmuList.name}: </label>\n                <div id="${eleIds.danmuListDiv}" style="margin: 1% 0;"></div>\n                <textarea id="${eleIds.danmuListText}" readOnly style="display: none;resize: vertical;width: 100%" rows="8"\n                    is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                <div class="${classes.embyFieldDesc}">列表展示格式为: [序号][分:秒] : 弹幕正文 [来源平台][用户ID][弹幕CID][模式]</div>\n            </div>\n            <div id="${eleIds.extInfoCtrlDiv}" style="margin: 0.6em 0;"></div>\n            <div id="${eleIds.extInfoDiv}" hidden>\n                <label class="${classes.embyLabel}">Bangumi 角色介绍: </label>\n                <div style="${styles.embySlider+"margin: 0.8em 0;"}">\n                    <label class="${classes.embyLabel}" style="width:7em;">角色图片高度: </label>\n                    <div id="${eleIds.characterImgHeihtDiv}" style="width: 36.5em; text-align: center;"></div>\n                    <label>\n                        <label id="${eleIds.characterImgHeihtLabel}" style="${styles.embySliderLabel}">auto</label>\n                        <label>em</label>\n                    </label>\n                </div>\n                <div id="${eleIds.charactersDiv}" style="display: flex; flex-wrap: wrap;"></div>\n            </div>\n        `;t.innerHTML=o.trim(),i&&getById(eleIds.posterImgDiv,t).append(embyImgButton(embyImg(dandanplayApi.posterImg(i)),"width: calc((var(--videoosd-tabs-height) - 3em) * (2 / 3)); margin-right: 1em;")),buildDanmuListDiv(t),buildExtInfo(t)}function buildDanmuListDiv(e){const{episodeId:t}=window.ede.episode_info||{},n=window.ede.extCommentCache[window.ede.itemId]||{},i=Object.values(n).map(((e,t)=>({id:`ext${t+1}`,name:`附加${t+1}`,onChange:()=>danmakuParser(e)})));let a=danmuListOpts;if(i.length>0){const e={id:"dandanplay",name:"弹弹 play",onChange:()=>{const e=window.ede.danmuCache[t];return e?danmakuParser(e):[]}};a=a.concat(e).concat(i)}getById(eleIds.danmuListDiv,e).append(embyTabs(a,lsKeys.danmuList.defaultValue,"id","name",doDanmuListOptsChange))}function buildExtInfo(e){getById(eleIds.characterImgHeihtDiv,e).append(embySlider({labelId:eleIds.characterImgHeihtLabel,value:"12",min:12,max:100,step:1},((e,t)=>{"12"===e&&(e="auto"),onSliderChangeLabel(e,t),Array.from(getById(eleIds.charactersDiv).children).map((t=>t.style.height="auto"===e?e:e+"em"))})));getById(eleIds.extInfoCtrlDiv,e).append(embyButton({label:"额外信息",iconKey:iconKeys.more},(e=>{const t=!e.target.xChecked;e.target.xChecked=t,e.target.title=t?"关闭":"额外信息",e.target.firstChild.innerHTML=t?iconKeys.close:iconKeys.more;getById(eleIds.extInfoDiv).hidden=!t;const n=getById(eleIds.charactersDiv);if(n.firstChild)return;const i=window.ede.bangumiInfo;if(i&&i.characters&&i.animeId===window.ede.episode_info.animeId)return a(n,i.characters);function a(e,t){t.map((t=>{const n=document.createElement("div");n.style="width: 31%; display: flex; margin: .5em;";let i=embyImg(t.images.large,"object-position: top;");t.images.large||(i=embyI(iconKeys.person,classes.cardImageIcon)),n.append(embyImgButton(i));const a=document.createElement("div");a.style.marginLeft=".5em";const l=document.createElement("div");l.textContent=t.relation+": "+t.name,a.append(l);const s=document.createElement("div");s.textContent="CV: "+t.actors.map((e=>e.name)).join(),t.actors[0]&&s.append(embyImgButton(embyImg(t.actors[0].images.large))),a.append(s),n.append(a),e.append(n)}))}getEpisodeBangumiRel().then((e=>fetchJson(bangumiApi.getCharacters(e.subjectId)))).then((e=>{i.characters=e,a(n,e)}))})))}function buildProSetting(e){const t=getById(e);let n=`\n            <div style="height: 30em;">\n                <div is="emby-collapse" title="弹幕屏蔽" data-expanded="true">\n                    <div class="${classes.collapseContentNav}">\n                        <div id="${eleIds.danmakuTypeFilterDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.typeFilter.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuSourceFilterDiv}">\n                            <label class="${classes.embyLabel}">${lsKeys.sourceFilter.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuShowSourceDiv}">\n                            <label class="${classes.embyLabel}">${lsKeys.showSource.name}: </label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="弹幕高级屏蔽">\n                    <div class="${classes.collapseContentNav}">\n                        <div>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 10em;">${lsKeys.autoFilterCount.name}: </label>\n                                <div id="${eleIds.danmakuAutoFilterCountDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label style="${styles.embySliderLabel}">0</label>\n                            </div>\n                            <label class="${classes.embyLabel}">${lsKeys.mergeSimilarEnable.name}: </label>\n                            <div id="${eleIds.danmakuFilterProDiv}" class="${classes.embyCheckboxList}" style="${styles.embyCheckboxList}"></div>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 10em;">${lsKeys.mergeSimilarPercent.name}: </label>\n                                <div id="${eleIds.mergeSimilarPercentDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label>\n                                    <label style="${styles.embySliderLabel}"></label>\n                                    <label>%</label>\n                                </label>\n                            </div>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width: 10em;">${lsKeys.mergeSimilarTime.name}: </label>\n                                <div id="${eleIds.mergeSimilarTimeDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label style="${styles.embySliderLabel}">-1</label>\n                            </div>\n                        </div>\n                        <div id="${eleIds.filterKeywordsDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.filterKeywords.name}: </label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="额外设置">\n                    <div class="${classes.collapseContentNav}" style="padding-top: 0.5em !important;">\n                        <div id="${eleIds.extCheckboxDiv}" class="${classes.embyCheckboxList}" style="${styles.embyCheckboxList}"></div>\n                        <div id="${eleIds.danmakuChConverDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.chConvert.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuEngineDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.engine.name}: </label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="播放设置">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">单次定时执行: </label>\n                        <div id="${eleIds.timeoutCallbackTypeDiv}"></div>\n                        <label class="${classes.embyLabel}">定时单位: </label>\n                        <div id="${eleIds.timeoutCallbackUnitDiv}"></div>\n                        <div style="${styles.embySlider+"margin-top: 0.3em;"}">\n                            <label class="${classes.embyLabel}" style="width:4em;">${lsKeys.timeoutCallbackValue.name}: </label>\n                            <div id="${eleIds.timeoutCallbackDiv}" style="width: 15.5em; text-align: center;"></div>\n                            <label id="${eleIds.timeoutCallbackLabel}" style="${styles.embySliderLabel}"></label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="Bangumi 设置">\n                    <div class="${classes.collapseContentNav}" style="padding-top: 0.5em !important;">\n                        <label id="${eleIds.bangumiEnableLabel}" class="${classes.embyLabel}"></label>\n                        <div id="${eleIds.bangumiSettingsDiv}">\n                            <div id="${eleIds.bangumiTokenInputDiv}" style="display: flex;" ></div>\n                            <div id="${eleIds.bangumiTokenLabel}" class="${classes.embyFieldDesc}"></div>\n                            <div class="${classes.embyFieldDesc}">\n                                你可以在以下链接生成一个 Access Token\n                            </div>\n                            <div id="${eleIds.bangumiTokenLinkDiv}" style="padding-bottom: 0.5em;"></div>\n                            <label class="${classes.embyLabel}">自动更新单章节收藏信息: </label>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width:4em;">${lsKeys.bangumiPostPercent.name}: </label>\n                                <div id="${eleIds.bangumiPostPercentDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label>\n                                    <label style="${styles.embySliderLabel}"></label>\n                                    <label>%</label>\n                                </label>\n                            </div>\n                            <div class="${classes.embyFieldDesc}">\n                                触发时机为正常停止播放,且播放进度超过设定百分比时;\n                                同步的媒体信息为自动匹配而来,可在"弹幕信息"中查看;\n                                自动匹配有误可"手动匹配",仍无法匹配可点击按钮X"取消匹配/清除弹幕",则此单章节不会同步;\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="自定义接口地址">\n                    <div id="${eleIds.customeUrlsDiv}" class="${classes.collapseContentNav}"></div>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),buildDanmakuFilterSetting(t),buildExtSetting(t),buildPlaySetting(t),buildBangumiSetting(t),buildCustomUrlSetting(t)}function buildDanmakuFilterSetting(e){getById(eleIds.danmakuTypeFilterDiv,e).append(embyCheckboxList(null,eleIds.danmakuTypeFilterSelectName,lsGetItem(lsKeys.typeFilter.id),Object.values(danmakuTypeFilterOpts).filter((e=>!e.hidden)),doDanmakuTypeFilterSelect)),getById(eleIds.danmakuSourceFilterDiv,e).append(embyCheckboxList(null,eleIds.danmakuSourceFilterSelectName,lsGetItem(lsKeys.sourceFilter.id),Object.values(danmakuSource),doDanmakuSourceFilterSelect)),getById(eleIds.danmakuShowSourceDiv,e).append(embyCheckboxList(null,eleIds.danmakuShowSourceSelectName,lsGetItem(lsKeys.showSource.id),Object.values(showSource),doDanmakuShowSourceSelect)),getById(eleIds.danmakuAutoFilterCountDiv).append(embySlider({lsKey:lsKeys.autoFilterCount},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuFilterProDiv,e).append(embyCheckbox({label:labels.enable},lsGetItem(lsKeys.mergeSimilarEnable.id),(e=>{lsSetItem(lsKeys.mergeSimilarEnable.id,e),loadDanmaku(LOAD_TYPE.RELOAD)}))),getById(eleIds.mergeSimilarPercentDiv).append(embySlider({lsKey:lsKeys.mergeSimilarPercent},onSliderChange,onSliderChangeLabel)),getById(eleIds.mergeSimilarTimeDiv).append(embySlider({lsKey:lsKeys.mergeSimilarTime},onSliderChange,onSliderChangeLabel));const t=getById(eleIds.filterKeywordsDiv,e),n=t.appendChild(document.createElement("div")),i=embyButton({label:"加载关键词过滤",iconKey:iconKeys.done_disabled},doDanmakuFilterKeywordsBtnClick);i.disabled=!0,n.setAttribute("style","display: flex; justify-content: space-between; align-items: center; width: 100%;"),n.append(embyCheckbox({id:eleIds.filterKeywordsEnableId,label:labels.enable},lsGetItem(lsKeys.filterKeywordsEnable.id),(e=>updateFilterKeywordsBtn(i,e,getById(eleIds.filterKeywordsId).value.trim())))),n.appendChild(document.createElement("div")).appendChild(i),t.appendChild(document.createElement("div")).appendChild(embyTextarea({id:eleIds.filterKeywordsId,value:lsGetItem(lsKeys.filterKeywords.id),style:"width: 100%;margin-top: 0.2em;",rows:8},(e=>updateFilterKeywordsBtn(i,getById(eleIds.filterKeywordsEnableId).checked,e.target.value.trim()))));const a=document.createElement("label");a.innerText=`关键词/正则匹配过滤,支持过滤[正文,${Object.values(showSource).map((e=>e.name)).join()}],多个表达式用换行分隔`,a.className=classes.embyFieldDesc,t.appendChild(document.createElement("div")).appendChild(a)}function buildExtSetting(e){getById(eleIds.extCheckboxDiv,e).append(embyCheckbox({label:lsKeys.osdTitleEnable.name},lsGetItem(lsKeys.osdTitleEnable.id),(e=>{lsSetItem(lsKeys.osdTitleEnable.id,e);const t=document.querySelector(`${mediaContainerQueryStr} .videoOsdSecondaryText`),n=getById(eleIds.videoOsdDanmakuTitle,t);n?n.style.display=e?"block":"none":e&&appendvideoOsdDanmakuInfo(getDanmakuComments(window.ede).length)}))),getById(eleIds.extCheckboxDiv,e).append(embyCheckbox({label:lsKeys.osdLineChartEnable.name},lsGetItem(lsKeys.osdLineChartEnable.id),(e=>{lsSetItem(lsKeys.osdLineChartEnable.id,e);const t=getById(eleIds.progressBarLineChart);t?t.style.display=e?"block":"none":e&&buildProgressBarChart(20)}))),getById(eleIds.extCheckboxDiv,e).append(embyCheckbox({label:lsKeys.osdHeaderClockEnable.name},lsGetItem(lsKeys.osdHeaderClockEnable.id),(e=>{lsSetItem(lsKeys.osdHeaderClockEnable.id,e),e?addHeaderClock():removeHeaderClock()}))),getById(eleIds.danmakuChConverDiv,e).append(embyTabs(danmakuChConverOpts,window.ede.chConvert,"id","name",doDanmakuChConverChange)),getById(eleIds.danmakuEngineDiv,e).append(embyTabs(danmakuEngineOpts,lsGetItem(lsKeys.engine.id),"id","name",doDanmakuEngineSelect))}function buildPlaySetting(e){const t=getById(eleIds.timeoutCallbackDiv,e),n={labelId:eleIds.timeoutCallbackLabel,key:lsKeys.timeoutCallbackValue.id,needReload:!1};onSliderChangeLabel(lsGetItem(lsKeys.timeoutCallbackValue.id),n),timeOffsetBtns.forEach((e=>{t.append(embyButton(e,(e=>{if(e.target){let t=lsGetItem(lsKeys.timeoutCallbackValue.id),i=t+(parseFloat(e.target.getAttribute("valueOffset"))||0);(i===t||i<0)&&(i=0),onSliderChange(i,n)}})))})),getById(eleIds.timeoutCallbackUnitDiv,e).append(embyTabs(timeoutCallbackUnitOpts,lsGetItem(lsKeys.timeoutCallbackUnit.id),"id","name",((e,t)=>{lsSetItem(lsKeys.timeoutCallbackUnit.id,t)}))),getById(eleIds.timeoutCallbackTypeDiv,e).append(embyTabs(timeoutCallbackTypeOpts,timeoutCallbackTypeOpts[0].id,"id","name",(e=>{const t=timeoutCallbackUnitOpts[lsGetItem(lsKeys.timeoutCallbackUnit.id)];e.onChange(lsGetItem(lsKeys.timeoutCallbackValue.id)*t.msRate)})))}function buildBangumiSetting(e){const t=getById(eleIds.bangumiSettingsDiv,e),n=lsGetItem(lsKeys.bangumiEnable.id);t.hidden=!n;getById(eleIds.bangumiEnableLabel,e).append(embyCheckbox({label:lsKeys.bangumiEnable.name},n,(e=>{lsSetItem(lsKeys.bangumiEnable.id,e),t.hidden=!e})));const i=getById(eleIds.bangumiTokenInputDiv,e);i.append(embyInput({id:eleIds.bangumiTokenInput,type:"password",value:lsGetItem(lsKeys.bangumiToken.id)},onEnterBangumiToken)),i.append(embyButton({label:"校验",iconKey:iconKeys.check},onEnterBangumiToken)),getById(eleIds.bangumiPostPercentDiv,e).append(embySlider({lsKey:lsKeys.bangumiPostPercent,needReload:!1},((e,t)=>{onSliderChange(e,t)}),onSliderChangeLabel));getById(eleIds.bangumiTokenLinkDiv,e).append(embyALink(bangumiApi.accessTokenUrl,bangumiApi.accessTokenUrl))}function onEnterBangumiToken(e){const t=getById(eleIds.bangumiTokenInput).value.trim();lsSetItem(lsKeys.bangumiToken.id,t);const n=getById(eleIds.bangumiTokenLabel);fetchJson(bangumiApi.getMyself(),{token:t}).then((e=>{n.innerText="Bangumi Token 验证成功",n.style.color="green",console.log("bangumiApi.getMyself()",e)})).catch((e=>{throw n.innerText="Bangumi Token 验证失败",n.style.color="red",e}))}function buildCustomUrlSetting(e){customeUrl.mapping.map((t=>(getById(eleIds.customeUrlsDiv,e).innerHTML+=(e=>`\n            <label class="${classes.embyLabel}">${e.lsKey.name}(${e.msg1}): </label>\n            <div id="${e.divId}" style="display: flex;" ></div>\n            <div class="${classes.embyFieldDesc}">${e.msg2?e.msg2:""}</div>\n        `)(t),t))).map((t=>{const n=getById(t.divId,e),i=e=>{const n=getTargetInput(e);let i=n.value.trim();i||(i=t.lsKey.defaultValue,n.value=i),lsSetItem(t.lsKey.id,i),t.rewrite(i)};n.append(embyInput({type:"search",value:lsGetItem(t.lsKey.id)},i)),n.append(embyButton({label:"确认",iconKey:iconKeys.check},i))}))}function buildAbout(e){const t=getById(e);if(!t)return;const n=`\n            <div style="height: 30em;">\n                <div id="${eleIds.consoleLogCtrl}"></div>\n                <div id="${eleIds.consoleLogInfo}">\n                    <textarea id="${eleIds.consoleLogText}" readOnly style="resize: vertical;margin-top: 0.6em;"\n                        rows="12" is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                    <textarea id="${eleIds.consoleLogTextInput}" hidden style="resize: vertical;"\n                        rows="1" is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                </div>\n                <div class="${classes.embyFieldDesc}">注意开启后原本控制台中调用方信息将被覆盖,不使用请保持关闭状态</div>\n                <div id="${eleIds.consoleLogCtrl}"></div>\n                <div is="emby-collapse" title="开发者选项">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">调试开关: </label>\n                        <div id="${eleIds.debugCheckbox}" class="${classes.embyCheckboxList}" style="${styles.embyCheckboxList}"></div>\n                        <label class="${classes.embyLabel}">调试按钮: </label>\n                        <div id="${eleIds.debugButton}"></div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="开放源代码许可" data-expanded="true" style="margin-top: 0.6em;">\n                    <div id="${eleIds.openSourceLicenseDiv}" class="${classes.collapseContentNav}" style="display: flex; flex-direction: column;"></div>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),buildConsoleLog(t),buildDebugCheckbox(t),buildDebugButton(t),buildOpenSourceLicense(t)}function buildConsoleLog(container){const consoleLogEnable=lsGetItem(lsKeys.consoleLogEnable.id);getById(eleIds.consoleLogInfo,container).style.display=consoleLogEnable?"":"none",consoleLogEnable&&doConsoleLogChange(consoleLogEnable);const consoleLogCtrlEle=getById(eleIds.consoleLogCtrl,container);consoleLogCtrlEle.append(embyCheckbox({label:lsKeys.consoleLogEnable.name},consoleLogEnable,doConsoleLogChange));const consoleLogCountLabel=document.createElement("label");consoleLogCountLabel.id=eleIds.consoleLogCountLabel,consoleLogCtrlEle.append(embyButton({label:"清空",iconKey:iconKeys.block},(()=>{getById(eleIds.consoleLogText,container).value="",getById(eleIds.consoleLogCountLabel).innerHTML="",window.ede.appLogAspect&&(window.ede.appLogAspect.value="")})),consoleLogCountLabel);const consoleLogTextInput=getById(eleIds.consoleLogTextInput,container);consoleLogTextInput.style.display=consoleLogEnable&&lsGetItem(lsKeys.quickDebugOn.id)?"":"none",consoleLogTextInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const inputVal=e.target.value.trim();console.log("输入内容为: \n",inputVal),eval(inputVal),e.target.value=""}}))}function buildDebugCheckbox(e){const t=getById(eleIds.debugCheckbox,e);t.append(embyCheckbox({label:lsKeys.debugShowDanmakuWrapper.name},lsGetItem(lsKeys.debugShowDanmakuWrapper.id),(e=>{lsSetItem(lsKeys.debugShowDanmakuWrapper.id,e);const t=getById(eleIds.danmakuWrapper);if(t.style.backgroundColor=e?styles.colors.highlight:"",!e)return;console.log(`弹幕容器(#${eleIds.danmakuWrapper})宽高像素:`,t.offsetWidth,t.offsetHeight);const n=t.firstChild;console.log(`实际舞台(${n.tagName})宽高像素:`,n.offsetWidth,n.offsetHeight)}))),t.append(embyCheckbox({label:lsKeys.debugShowDanmakuCtrWrapper.name},lsGetItem(lsKeys.debugShowDanmakuCtrWrapper.id),(e=>{lsSetItem(lsKeys.debugShowDanmakuCtrWrapper.id,e);const t=getById(eleIds.danmakuCtr);t.style.backgroundColor=e?styles.colors.highlight:"",e&&console.log(`按钮容器(#${eleIds.danmakuCtr})宽高像素:`,t.offsetWidth,t.offsetHeight)}))),t.append(embyCheckbox({label:lsKeys.debugReverseDanmu.name},lsGetItem(lsKeys.debugReverseDanmu.id),(e=>{lsSetItem(lsKeys.debugReverseDanmu.id,e);const t=window.ede.danmuCache[window.ede.episode_info.episodeId];t.map((e=>{const t=e.p.split(",");t[1]={6:"1",1:"6",5:"4",4:"5"}[t[1]],e.p=t.join()})),console.log("已"+lsKeys.debugReverseDanmu.name),createDanmaku(t)})));const n=(e,t,n)=>{lsSetItem(t.id,e);let i=window.ede.danmuCache[window.ede.episode_info.episodeId];e?(window.ede._oriComments=structuredClone(i),i=i.map((e=>{const t=e.p.split(",");return t[2]=n(),{...e,p:t.join()}})),console.log("已"+t.name)):(i=window.ede._oriComments,window.ede.danmuCache[window.ede.episode_info.episodeId]=i,console.log("已还原"+t.name)),createDanmaku(i)};t.append(embyCheckbox({label:lsKeys.debugRandomDanmuColor.name},lsGetItem(lsKeys.debugRandomDanmuColor.id),(e=>{n(e,lsKeys.debugRandomDanmuColor,(()=>parseInt(Math.floor(16777215*Math.random()).toString(16).padStart(6,"0"),16)))}))),t.append(embyCheckbox({label:lsKeys.debugForceDanmuWhite.name},lsGetItem(lsKeys.debugForceDanmuWhite.id),(e=>{n(e,lsKeys.debugForceDanmuWhite,(()=>parseInt(styles.colors.info.toString(16).padStart(6,"0"),16)))})));const i=document.querySelector("."+classes.dialogContainer),a=i.firstChild,l=i.classList.contains(classes.dialogBackdropOpened),s=a.classList.contains(classes.dialogBlur),o=e=>{lsSetItem(lsKeys.debugDialogHyalinize.id,e),e?(a.classList.remove(classes.dialog),l&&i.classList.remove(classes.dialogBackdropOpened),s&&a.classList.remove(classes.dialogBlur)):(a.classList.add(classes.dialog),l&&i.classList.add(classes.dialogBackdropOpened),s&&a.classList.add(classes.dialogBlur))},d=lsGetItem(lsKeys.debugDialogHyalinize.id);o(d),t.append(embyCheckbox({label:lsKeys.debugDialogHyalinize.name},d,o));const r=a.classList.contains(classes.dialogFullscreen),m=a.classList.contains(classes.dialogFullscreenLowres),c=e=>{lsSetItem(lsKeys.debugDialogWindow.id,e),r&&a.classList.toggle(classes.dialogFullscreen,!e),m&&a.classList.toggle(classes.dialogFullscreenLowres,!e)},u=lsGetItem(lsKeys.debugDialogWindow.id);c(u),t.append(embyCheckbox({label:lsKeys.debugDialogWindow.name},u,c));const y=e=>{lsSetItem(lsKeys.debugDialogRight.id,e),i.classList.toggle(classes.dialogBackdropOpened,!e),a.style=e?styles.rightLayout:"",e&&(r&&a.classList.remove(classes.dialogFullscreen),m&&a.classList.remove(classes.dialogFullscreenLowres,!e))},g=lsGetItem(lsKeys.debugDialogRight.id);y(g),t.append(embyCheckbox({label:lsKeys.debugDialogRight.name},g,y)),lsGetItem(lsKeys.quickDebugOn.id)&&t.append(embyCheckbox({label:lsKeys.debugTabIframeEnable.name},lsGetItem(lsKeys.debugTabIframeEnable.id),(e=>{lsSetItem(lsKeys.debugTabIframeEnable.id,e),getById(tabIframeId+"Btn").style.display=e?"":"none"})))}function buildDebugButton(e){const t=getById(eleIds.debugButton,e);t.append(embyButton({label:"打印环境信息",style:"margin: 0.3em;"},(()=>{require(["browser"],(e=>{console.log("Emby 内部自身判断: ",e)}))}))),t.append(embyButton({label:"打印弹幕引擎信息",style:"margin: 0.3em;"},(()=>{const e=`弹幕引擎是否存在: ${!!window.Danmaku}, 弹幕引擎是否实例化成功: ${!!window.ede.danmaku}`;console.log(e),embyToast({text:e})}))),t.append(embyButton({label:"打印视频加载方",style:"margin: 0.3em;"},(()=>{const e=document.querySelector(mediaQueryStr);if(!e)return console.error("严重错误,页面中依旧不存在 <video> 标签");if(e.currentTime<1&&console.error("严重错误,<video> 的 currentTime < 1"),e.id){console.log("当前 <video> 标签为虚拟适配器:",e.outerHTML);const t=document.querySelector("embed");t?console.log("视频加载方为 <embed> 标签占位的 Native 播放器:",t.parentNode.outerHTML):console.log("视频加载方为无占位标签的 Native 播放器,无信息")}else console.log("视频加载方为 Web 端 <video> 标签:",e.parentNode.outerHTML)}))),t.append(embyButton({label:"清空章节引用缓存",class:classes.embyButtons.submit,style:"margin: 0.3em;"},(()=>{lsBatchRemove(["_episode_id_rel_","_bangumi_episode_id_rel_"]),console.log("已清空章节引用缓存"),embyToast({text:"已清空章节引用缓存"})}))),t.append(embyButton({label:"重置设置",class:classes.embyButtons.submit,style:"margin: 0.3em;"},(()=>{settingsReset(),console.log(`已重置设置, 跳过了 ${lsKeys.filterKeywords.name} 重置`),embyToast({text:`已重置设置, 跳过了 ${lsKeys.filterKeywords.name} 重置`}),loadDanmaku(LOAD_TYPE.INIT),closeEmbyDialog()})))}function buildOpenSourceLicense(e){const t=getById(eleIds.openSourceLicenseDiv,e);objectEntries(openSourceLicense).map((([e,n])=>{t.append(embyALink(n.url,[e,n.name,n.version,n.license].join(" : ")))}))}function buildIframe(e){const t=getById(e),n=`\n            <div>\n                <div class="${classes.embyFieldDesc}">注意内嵌网页不支持控制器输入,且被禁止内嵌(CSP)的网页无法显示,且跨域无法登录</div>\n                <div style="${styles.embySlider+"margin: 0.8em 0;"}">\n                    <label class="${classes.embyLabel}" style="width: 5em;">网页高度: </label>\n                    <div id="${eleIds.tabIframeHeightDiv}" style="width: 40.5em; text-align: center;"></div>\n                    <label>\n                        <label id="${eleIds.tabIframeHeightLabel}" style="${styles.embySliderLabel}">auto</label>\n                        <label>em</label>\n                    </label>\n                </div>\n                <div id="${eleIds.tabIframeCtrlDiv}"></div>\n                <div id="${eleIds.tabIframeSrcInputDiv}" style="display: flex; margin-top: 0.6em;"></div>\n                <iframe id="${eleIds.tabIframe}" style="border: 0;width: 100%;" src=""></iframe>\n            </div>\n        `;t.innerHTML=n.trim(),getById(eleIds.tabIframeHeightDiv,t).append(embySlider({labelId:eleIds.tabIframeHeightLabel,value:"29",min:28,max:100,step:1},((e,t)=>{"28"===e&&(e="auto"),onSliderChangeLabel(e,t),getById(eleIds.tabIframe).style.height="auto"===e?e:e+"em"}))),getById(eleIds.tabIframeSrcInputDiv,t).append(embyInput({type:"search",value:window.ede.bangumiInfo?window.ede.bangumiInfo.bangumiUrl:""},(e=>{getById(eleIds.tabIframe).src=e.target.value.trim()})))}function appendvideoOsdDanmakuInfo(e){if(!lsGetItem(lsKeys.osdTitleEnable.id))return;const t=window.ede.episode_info||{},{episodeId:n,animeTitle:i,episodeTitle:a}=t,l=document.querySelector(`${mediaContainerQueryStr} .videoOsdSecondaryText`);let s=getById(eleIds.videoOsdDanmakuTitle,l);s||(s=document.createElement("h3"),s.id=eleIds.videoOsdDanmakuTitle,s.classList.add(classes.videoOsdTitle),s.style="margin-left: auto; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; position: absolute; right: 0px; bottom: 0px;");let o="弹幕：";o+=n?`${i} - ${a} - ${e}条`:"未匹配",s.innerText=o,l&&l.append(s)}function toggleSettingBtn2Header(){const e=getById(eleIds.danmakuSettingBtnDebug);if(e)return e.remove(),!1;const t=mediaBtnOpts[1];return t.id=eleIds.danmakuSettingBtnDebug,getByClass(classes.headerRight).prepend(embyButton(t,t.onClick)),!0}function quickDebug(){const e=toggleSettingBtn2Header();embyToast({text:`${lsKeys.quickDebugOn.name}: ${e}!`}),window.ede||(window.ede=new EDE),lsSetItem(lsKeys.quickDebugOn.id,e),checkRuntimeVars()}function checkRuntimeVars(e=!0){console.log("运行时变量检查"),console.log(lsKeys.customeCorsProxyUrl.name,corsProxy),console.log(lsKeys.customeDanmakuUrl.name,requireDanmakuPath),console.log("弹弹 play API 模板",dandanplayApi),e&&(window.checkRuntimeVars=checkRuntimeVars)}function doDanmakuSwitch(){console.log("切换"+lsKeys.switch.name);const e=!lsGetItem(lsKeys.switch.id);window.ede.danmaku&&(e?window.ede.danmaku.show():window.ede.danmaku.hide());const t=getById(eleIds.danmakuSwitchBtn);t&&(t.firstChild.innerHTML=e?iconKeys.comment:iconKeys.comments_disabled);const n=getById(eleIds.danmakuSwitch);n&&(n.firstChild.innerHTML=e?iconKeys.switch_on:iconKeys.switch_off,n.style.color=e?styles.colors.switchActiveColor:""),lsSetItem(lsKeys.switch.id,e)}async function doDanmakuSearchEpisode(){let e=getById(eleIds.danmakuSearchName);if(!e)return;let t=e.value;const n=getById(eleIds.danmakuRemark);n.parentNode.hidden=!1,n.innerText=t?"":"请填写标题";const i=getByClass(classes.mdlSpinner);i.classList.remove("hide");const a=await fetchSearchEpisodes(t);if(i.classList.add("hide"),!a||a.animes.length<1)return n.innerText="搜索结果为空",getById(eleIds.danmakuSwitchEpisode).disabled=!0,void(getById(eleIds.danmakuEpisodeFlag).hidden=!0);n.innerText="";const l=getById(eleIds.danmakuAnimeDiv),s=getById(eleIds.danmakuEpisodeNumDiv);l.innerHTML="",s.innerHTML="";const o=a.animes;window.ede.searchDanmakuOpts.animes=o;let d=o.findIndex((e=>e.animeId==window.ede.searchDanmakuOpts.animeId));d=-1!==d?d:0;const r=embySelect({id:eleIds.danmakuAnimeSelect,label:"剧集: ",style:"width: auto;max-width: 100%;"},d,o,"animeId",(e=>`${e.animeTitle} 类型：${e.typeDescription}`),doDanmakuAnimeSelect);l.append(r);const m=embySelect({id:eleIds.danmakuEpisodeNumSelect,label:"集数: ",style:"width: auto;max-width: 100%;"},window.ede.searchDanmakuOpts.episode,o[d].episodes,"episodeId","episodeTitle");s.append(m),getById(eleIds.danmakuEpisodeFlag).hidden=!1,getById(eleIds.danmakuSwitchEpisode).disabled=!1,getById(eleIds.searchImg).src=dandanplayApi.posterImg(o[d].animeId)}function doSearchTitleSwtich(e){const t=getById(eleIds.danmakuSearchName),n="isOriginalTitle";if("1"===e.target.getAttribute(n))return e.target.setAttribute(n,"0"),t.value=window.ede.searchDanmakuOpts.animeName;const{_episode_key:i,seriesOrMovieId:a}=window.ede.searchDanmakuOpts,l=JSON.parse(localStorage.getItem(i)),{animeOriginalTitle:s}=l;if(s)return e.target.setAttribute(n,"1"),t.value=s;ApiClient.getItem(ApiClient.getCurrentUserId(),a).then((a=>{a.OriginalTitle&&(e.target.setAttribute(n,"1"),t.value=a.OriginalTitle,l.animeOriginalTitle=a.OriginalTitle,localStorage.setItem(i,JSON.stringify(l)),window.ede.episode_info.animeOriginalTitle=a.OriginalTitle)}))}function doDanmakuAnimeSelect(e,t,n){const i=getById(eleIds.danmakuEpisodeNumDiv);i.innerHTML="";const a=window.ede.searchDanmakuOpts.animes[t],l=embySelect({id:eleIds.danmakuEpisodeNumSelect,label:"集数: "},t,a.episodes,"episodeId","episodeTitle");l.style.maxWidth="100%",i.append(l),getById(eleIds.searchImg).src=dandanplayApi.posterImg(a.animeId)}function doDanmakuSwitchEpisode(){const e=getById(eleIds.danmakuAnimeSelect),t=getById(eleIds.danmakuEpisodeNumSelect),n=window.ede.searchDanmakuOpts.animes[e.selectedIndex],i={episodeId:t.value,episodeTitle:t.options[t.selectedIndex].text,episodeIndex:t.selectedIndex,animeId:n.animeId,animeTitle:n.animeTitle},a={name:n.animeTitle,episodeOffset:t.selectedIndex-window.ede.searchDanmakuOpts.episode};writeLsSeasonInfo(window.ede.searchDanmakuOpts._season_key,a),localStorage.setItem(window.ede.searchDanmakuOpts._episode_key,JSON.stringify(i)),console.log("手动匹配信息:",i),loadDanmaku(LOAD_TYPE.RELOAD),closeEmbyDialog()}function writeLsSeasonInfo(e,t){if(!e)return console.log("_season_key is undefined, skip");let n=localStorage.getItem(e),i=n?JSON.parse(n):[];const a=i.find((e=>e.name===t.name));a?Object.assign(a,t):i.push(t),localStorage.setItem(e,JSON.stringify(i))}function doDanmakuEngineSelect(e){let t=e.id;lsCheckSet(lsKeys.engine.id,t)&&(console.log(`已更改弹幕引擎为: ${t}`),loadDanmaku(LOAD_TYPE.RELOAD))}function doDanmakuChConverChange(e){window.ede.chConvert=e.id,lsSetItem(lsKeys.chConvert.id,window.ede.chConvert),loadDanmaku(LOAD_TYPE.REFRESH),console.log(e.name)}function doDanmuListOptsChange(e,t){const n=getById(eleIds.danmuListText);n.style.display=t==lsKeys.danmuList.defaultValue?"none":"";const i=new Intl.DateTimeFormat("default",{minute:"2-digit",second:"2-digit"}),a=lsGetItem(lsKeys.showSource.id).length>0;n.value=e.onChange(window.ede).map(((e,t)=>`[${t+1}][${i.format(new Date(1e3*e.time))}] : `+(a?e.originalText:e.text)+(e.source?` [${e.source}]`:"")+(e.originalUserId?`[${e.originalUserId}]`:"")+(e.cid?`[${e.cid}]`:"")+`[${e.mode}]`)).join("\n")}function doDanmakuTypeFilterSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuTypeFilterSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.typeFilter.id,e),loadDanmaku(LOAD_TYPE.RELOAD);const t=new Map(Object.values(danmakuTypeFilterOpts).map((e=>[e.id,e.name])));console.log(`当前弹幕类型过滤为: ${JSON.stringify(e.map((e=>t.get(e))))}`)}function doDanmakuSourceFilterSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuSourceFilterSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.sourceFilter.id,e),loadDanmaku(LOAD_TYPE.RELOAD),console.log(`当前弹幕来源平台过滤为: ${JSON.stringify(e)}`)}function doDanmakuShowSourceSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuShowSourceSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.showSource.id,e),loadDanmaku(LOAD_TYPE.RELOAD);const t=new Map(Object.values(showSource).map((e=>[e.id,e.name])));console.log(`当前弹幕显示来源为: ${JSON.stringify(e.map((e=>t.get(e))))}`)}function onSliderChange(e,t){onSliderChangeLabel(e,t),t.key&&lsCheckSet(t.key,e)&&(void 0===t.needReload&&(t.needReload=!0),console.log(`${t.key} changed to ${e}, needReload: ${t.needReload}`),t.needReload&&(changeFontStylePreview(),loadDanmaku(LOAD_TYPE.RELOAD)))}function onSliderChangeLabel(e,t){t.labelId&&(getById(t.labelId).innerText=e),t.labelEle&&(t.labelEle.innerText=e)}function doDanmakuFilterKeywordsBtnClick(e){const t=e.currentTarget;t&&(t.style="",t.disabled=!0);let n=getById(eleIds.filterKeywordsId).value.trim(),i=getById(eleIds.filterKeywordsEnableId).checked;lsCheckSet(lsKeys.filterKeywordsEnable.id,i),(lsCheckSet(lsKeys.filterKeywords.id,n)||""!==n)&&loadDanmaku(LOAD_TYPE.RELOAD)}function updateFilterKeywordsBtn(e,t,n){const i=lsCheckOld(lsKeys.filterKeywordsEnable.id,t)&&lsCheckOld(lsKeys.filterKeywords.id,n);e.firstChild.innerHTML=i?iconKeys.done_disabled:iconKeys.done,e.disabled=i}function doConsoleLogChange(e){lsSetItem(lsKeys.consoleLogEnable.id,e),getById(eleIds.consoleLogInfo).style.display=e?"":"none";const t=getById(eleIds.consoleLogText);e?(window.ede.appLogAspect||(window.ede.appLogAspect=(new AppLogAspect).init()),t.value=window.ede.appLogAspect.value,window.ede.appLogAspect.on((e=>{if(t.value.length!==e.length){t.value=e,t.scrollTop=t.scrollHeight;const n=getById(eleIds.consoleLogCountLabel);n&&(n.innerHTML=`清空 ${e.split("\n").length-1} 行`)}}))):(t.value="",window.ede.appLogAspect.destroy(),window.ede.appLogAspect=null)}function getById(e,t=document){return t.querySelector(`#${e}`)}function getByClass(e,t=document){return t.querySelector(`.${e}`)}function getTargetInput(e){return"INPUT"===e.target.tagName?e.target:e.target.previousElementSibling}function embyInput(e,t,n){const i=document.createElement("input",{is:"emby-input"});return objectEntries(e).forEach((([e,t])=>{"function"!=typeof t&&i.setAttribute(e,t)})),i.className=classes.embyInput,"function"==typeof t&&i.addEventListener("keydown",(e=>{"Enter"===e.key&&t(e)})),"function"==typeof n&&i.addEventListener("change",n),i.addEventListener("keydown",(e=>{if(("ArrowLeft"===e.key||"ArrowRight"===e.key)&&(0===i.selectionStart&&"ArrowLeft"===e.key||i.selectionEnd===i.value.length&&"ArrowRight"===e.key)){e.stopPropagation(),e.preventDefault();var t={sourceElement:e.target,repeat:e.repeat,originalEvent:e};require(["inputmanager"],(n=>{n.trigger(e.key.replace("Arrow","").toLowerCase(),t)}))}})),i}function embyI(e,t){const n=document.createElement("i");return n.className="md-icon"+(t?" "+t:""),n.style="pointer-events: none;",n.innerHTML=e,n}function embyButton(e,t){const n=document.createElement("button");return n.setAttribute("is","emby-button"),n.setAttribute("type","button"),objectEntries(e).forEach((([e,t])=>{"iconKey"!==e&&"function"!=typeof t&&n.setAttribute(e,t)})),e.iconKey?(n.setAttribute("title",e.label),n.setAttribute("aria-label",e.label),n.innerHTML=embyI(e.iconKey).outerHTML,n.className=classes.embyButtons.iconButton):(n.classList.add(...classes.embyButtons.basic.split(" ")),n.textContent=e.label),"function"==typeof t&&n.addEventListener("click",t),n}function embyALink(e,t){const n=document.createElement("a");return n.setAttribute("is","emby-linkbutton"),n.href=e,n.textContent=t||e,n.target="_blank",n.className="button-link button-link-color-inherit button-link-fontweight-inherit emby-button",OS.isMobile()&&n.addEventListener("click",(t=>{t.preventDefault(),navigator.clipboard.writeText(e).then((()=>{console.log("Link copied to clipboard:",e);const t=document.createElement("label");t.textContent="已复制",t.style.color="green",t.style.paddingLeft="0.5em",n.append(t),setTimeout((()=>{n.removeChild(t)}),3e3)}),(e=>{console.error("Failed to copy link:",e)}))})),n}function embyTabs(e,t,n,i,a){const l=document.createElement("div",{is:"emby-tabs"});l.setAttribute("data-index","0"),l.className=classes.embyTabsDiv1,l.style.width="fit-content";const s=document.createElement("div");return s.className=classes.embyTabsDiv2,s.style.padding="0.25em",e.forEach(((e,a)=>{const l=getValueOrInvoke(e,n),o=getValueOrInvoke(e,i),d=document.createElement("button");d.id=e.id+"Btn",d.className=`${classes.embyTabsButton}${l==t?" emby-tab-button-active":""}`,d.setAttribute("data-index",a),d.textContent=o,d.style.display=e.hidden?"none":"",s.append(d)})),l.append(s),"function"==typeof a&&l.addEventListener("tabchange",(t=>a(e[t.detail.selectedTabIndex],t.detail.selectedTabIndex))),l}function embySelect(e,t,n,i,a,l){e={class:"emby-select",...e},Number.isInteger(t)||(t=n.indexOf(t));const s=document.createElement("select",{is:"emby-select"});require(["browser"],(e=>{e.tv&&s.classList.add(classes.embySelectTv)})),objectEntries(e).forEach((([e,t])=>{"function"!=typeof t&&s.setAttribute(e,t)})),n.forEach(((e,n)=>{const l=getValueOrInvoke(e,i),o=getValueOrInvoke(e,a),d=document.createElement("option");d.value=l,d.textContent=o,n===t&&(d.selected=!0),s.append(d)})),"function"==typeof l&&s.addEventListener("change",(e=>{l(e.target.value,e.target.selectedIndex,n[e.target.selectedIndex])}));const o=document.createElement("label");return o.classList.add("selectLabel"),o.appendChild(s),o}function embyCheckboxList(e,t,n,i,a,l=!1){const s=document.createElement("div");return s.setAttribute("class",classes.embyCheckboxList),s.setAttribute("style",l?"":styles.embyCheckboxList),s.setAttribute("id",e),i.forEach((e=>{s.append(embyCheckbox({name:t,label:e.name,value:e.id},!!n&&n.indexOf(e.id)>-1,a))})),s}function embyCheckbox({id:e,name:t,label:n,value:i},a=!1,l){const s=document.createElement("label");s.classList.add("emby-checkbox-label"),s.setAttribute("style","width: auto;");const o=document.createElement("input",{is:"emby-checkbox"});o.setAttribute("type","checkbox"),o.setAttribute("id",e),o.setAttribute("name",t),o.setAttribute("value",i),o.checked=a,o.classList.add("emby-checkbox","chkEnableLiveTvAccess"),"function"==typeof l&&o.addEventListener("change",(e=>l(e.target.checked)));const d=document.createElement("span");return d.setAttribute("class","checkboxLabel"),d.innerHTML=n,s.append(o),s.append(d),s}function embyTextarea(e,t){e={rows:10,styleResize:"vertical",readonly:!1,...e};const n=document.createElement("textarea",{is:"emby-textarea"});return objectEntries(e).forEach((([e,t])=>{"function"!=typeof t&&"readonly"!==e&&"styleResize"!==e&&"value"!==e&&n.setAttribute(e,t)})),n.className="txtOverview emby-textarea",n.readOnly=e.readonly,n.style.resize=e.styleResize,n.value=e.value,"function"==typeof t&&n.addEventListener("blur",t),n}function embySlider(e={},t,n){const i={min:.1,max:3,step:.1,orient:"horizontal","data-bubble":!1,"data-hoverthumb":!0,style:"",...e},a=document.createElement("input",{is:"emby-slider"});return a.setAttribute("type","range"),e.id&&a.setAttribute("id",e.id),objectEntries(i).forEach((([t,n])=>{if("lsKey"===t){e.key=n.id;const t=Object.keys(e);t.includes("value")||(i.value=lsGetItem(n.id)),t.includes("min")||a.setAttribute("min",n.min),t.includes("max")||a.setAttribute("max",n.max),t.includes("step")||a.setAttribute("step",n.step)}else a.setAttribute(t,n)})),"function"==typeof t&&a.addEventListener("change",(n=>{e.needReload=!n.isInit&&void 0;const i=n.target.parentNode.nextElementSibling;return e.labelEle=i.children.length>0?i.children[0]:i,t(n.target.value,e)})),"function"==typeof n&&a.addEventListener("input",(t=>{const i=t.target.parentNode.nextElementSibling;return e.labelEle=i.children.length>0?i.children[0]:i,n(t.target.value,e)})),i.value&&(a.setValue(i.value),waitForElement({element:a,needParent:!0},(e=>{const t=new Event("change");t.isInit=!0,a.dispatchEvent(t)}))),require(["browser"],(e=>{e.electron&&e.windows&&a.addEventListener("keydown",(e=>{const t=a.getAttribute("orient")||"horizontal";("horizontal"!==t||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key)&&("vertical"!==t||"ArrowUp"!==e.key&&"ArrowDown"!==e.key)||e.stopPropagation()}))})),a}async function embyDialog(e={}){return e={text:"",title:"",timeout:0,html:"",buttons:[],...e},require(["dialog"]).then((t=>t[0](e))).catch((e=>{console.log("点击弹出框外部取消: "+e)}))}function closeEmbyDialog(){getByClass(classes.formDialogFooterItem).dispatchEvent(new Event("click"))}function embyImg(e,t,n,i=!1){const a=document.createElement("img");return a.id=n,a.src=e,a.style=t,a.loading="lazy",a.decoding="async",a.draggable=i,a.className="coveredImage-noScale cardImage",a}function embyImgButton(e,t){const n=document.createElement("button");return n.style=t,n.className="cardContent-button cardImageContainer cardPadder-portrait defaultCardBackground",n.append(e),n.addEventListener("focus",(()=>{n.style.boxShadow="0 0 0 5px green"})),n.addEventListener("blur",(()=>{n.style.boxShadow=""})),n}async function embyAlert(e={}){return e={text:"",title:"",timeout:0,html:"",...e},require(["alert"]).then((t=>t[0](e))).catch((e=>{console.log("点击弹出框外部取消: "+e)}))}async function embyToast(e={}){return e={text:"",secondaryText:"",icon:"",iconStrikeThrough:!1,...e},require(["toast"],(t=>t(e)))}function getValueOrInvoke(e,t){return"function"==typeof t?t(e):e[t]}function getSettingsJson(e=4){return JSON.stringify(Object.fromEntries(objectEntries(lsKeys).map((([e,t])=>[t.id,lsGetItem(t.id)]))),null,e)}function settingsReset(){lsBatchSet(Object.fromEntries(objectEntries(lsKeys).filter((([e,t])=>lsKeys.filterKeywords.id!==t.id)).map((([e,t])=>[t.id,t.defaultValue]))))}function lsGetItem(e){const t=lsGetKeyById(e);if(!t)return null;const n=lsKeys[t].defaultValue,i=localStorage.getItem(e);return null===i?n:Array.isArray(n)||Array.isArray(n)||"object"==typeof n?JSON.parse(i):"boolean"==typeof n?"true"===i:"number"==typeof n?parseFloat(i):i}function lsCheckOld(e,t){return JSON.stringify(lsGetItem(e))===JSON.stringify(t)}function lsCheckSet(e,t){return!lsCheckOld(e,t)&&(lsSetItem(e,t),!0)}function lsBatchSet(e,t=!0){if(t)return objectEntries(e).reduce(((e,[t,n])=>e||lsCheckSet(t,n)),!1);objectEntries(e).forEach((([e,t])=>lsSetItem(e,t)))}function lsSetItem(e,t){if(!lsGetKeyById(e))return;let n;n=Array.isArray(t)||"object"==typeof t?JSON.stringify(t):t,localStorage.setItem(e,n)}function lsGetKeyById(e){return Object.keys(lsKeys).find((t=>lsKeys[t].id===e))}function lsBatchRemove(e){return Object.keys(localStorage).filter((t=>e.some((e=>t.startsWith(e))))).map((e=>localStorage.removeItem(e))).length>0}function destroyAllInterval(){window.ede.destroyIntervalIds.map((e=>clearInterval(e))),window.ede.destroyIntervalIds=[]}function waitForElement(e,t,n=1e4,i=check_interval){let a=null,l=null;const s="string"==typeof e,o=s?e:e.element.tagName;a=setInterval((function(){console.log(`waitForElement: checking element[${o}]`);let n=null;n=s?document.querySelector(e):e.needParent?e.element.parentNode:e.element,n&&(clearInterval(a),clearTimeout(l),t(n))}),i),window.ede.destroyIntervalIds.push(a),n>0&&(l=setTimeout((()=>{clearInterval(a),console.log(`waitForElement: unable to find element[${o}], timeout: ${n}`)}),n))}function addEasterEggListener(){const e=getByClass(classes.headerUserButton);if(!e)return;let t;function n(){t=setTimeout((()=>{console.log("恭喜你发现了隐藏功能, 长按了 2 秒!"),quickDebug()}),2e3)}function i(){clearTimeout(t)}const a=OS.isMobile();let l=a?"touchstart":"mousedown",s=a?"touchend":"mouseup";return require(["browser"],(t=>{t.tv&&(l="focus",s="blur"),"1"!==e.getAttribute("startFlag")&&(e.addEventListener(l,n),e.setAttribute("startFlag","1")),"1"!==e.getAttribute("endFlag")&&(e.addEventListener(s,i),e.setAttribute("endFlag","1"))})),()=>{e.removeEventListener(l,n),e.removeEventListener(s,i),clearTimeout(t)}}function initCss(){if(OS.isEmbyNoisyX()){if(!document.querySelector("style[css-emby-noisyx-fix]")){const e=document.createElement("style");e.setAttribute("css-emby-noisyx-fix",""),e.innerHTML='\n                    [class*="accent-"].noScrollY.transparentDocument .toast-group {\n                        position: fixed;\n                        top: auto;\n                    }\n                ',document.head.appendChild(e)}}}function removeHeaderClock(){const e=getById("headerClock");e&&e.remove(),destroyAllInterval()}function addHeaderClock(){const e=getByClass("headerMiddle");let t=getById("headerClock");if(!e)return;t&&t.remove();const n=document.createElement("div");n.id="headerClock",e.append(n);const i=setInterval((()=>{const e=(new Date).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit"});n.textContent=e,t=getById("headerClock"),t||clearInterval(i)}),1e3);return window.ede.destroyIntervalIds.push(i),i}async function playbackEventsOn(e){const[t,n]=await require(["playbackManager","events"]),i=t.getCurrentPlayer();i&&objectEntries(e).forEach((([e,t])=>{n.off(i,e,t),n.on(i,e,t)}))}function initH5VideoAdapter(){let e=document.querySelector(mediaQueryStr);e?e.id&&videoTimeUpdateInterval(e,!0):(console.log("播放页不存在 video 标签,适配器处理开始"),e=document.createElement("video"),OS.isApple()&&(e.src=""),e.style.display="none",e.id=eleIds.h5VideoAdapter,e.classList.add("htmlvideoplayer","moveUpSubtitles"),document.body.prepend(e),e.play(),videoTimeUpdateInterval(e,!0),require(["playbackManager"],(t=>{playbackEventsOn({timeupdate:n=>{const i=t.currentTime(t.getCurrentPlayer())/1e7,a=e.currentTime;e.currentTime=i;const l=t.getPlayerState().PlayState.PlaybackRate;e.playbackRate=l||1,Math.abs(a-i)>2&&(e.dispatchEvent(new Event("seeking")),console.warn("seeking",i,a))}})})),playbackEventsOn({pause:t=>{console.warn(t.type),e.dispatchEvent(new Event("pause")),videoTimeUpdateInterval(e,!1)},unpause:t=>{console.warn(t.type),e.dispatchEvent(new Event("play")),videoTimeUpdateInterval(e,!0)}}),console.log("已创建虚拟 video 标签,适配器处理正确结束"))}function videoTimeUpdateInterval(e,t){const n=e||document.querySelector(mediaQueryStr);n&&(t&&!n.timeupdateIntervalId?n.timeupdateIntervalId=setInterval((()=>{n.currentTime+=.1}),100):!t&&n.timeupdateIntervalId&&(clearInterval(n.timeupdateIntervalId),n.timeupdateIntervalId=null))}function beforeDestroy(){window.ede.danmaku&&window.ede.danmaku.clear();const e=getById(eleIds.danmakuCtr);e&&e.remove(),videoTimeUpdateInterval(null,!1),destroyAllInterval(),lsSetItem(lsKeys.timelineOffset.id,lsKeys.timelineOffset.defaultValue)}document.addEventListener("viewshow",(function(e){console.log(e.type,e),customeUrl.init(),lsGetItem(lsKeys.quickDebugOn.id)&&!getById(eleIds.danmakuSettingBtnDebug)&&quickDebug(),addEasterEggListener(),"video-osd"===e.detail.type&&(window.ede||(window.ede=new EDE),!window.ede.appLogAspect&&lsGetItem(lsKeys.consoleLogEnable.id)&&(window.ede.appLogAspect=(new AppLogAspect).init()),initUI(),initH5VideoAdapter(),initListener(),initCss()),window.ede.itemId=e.detail.params.id?e.detail.params.id:""})),document.addEventListener("viewbeforehide",(e=>"video-osd"===e.detail.type&&beforeDestroy()))})();